---
// Admin Sidebar
import { getUser } from "@lib/db";
const userId = Astro.locals.userId;
if (!userId) {
  throw new Error("Usuario no autenticado");
}
const user = await getUser(userId);
const { name, role } = user;
interface Props {
  activePage: string;
}
interface Props {
  activePage: string;
}

const { activePage} = Astro.props;

const adminItems = [
  {
    name: "Panel Principal",
    href: "/admin",
    icon: "dashboard",
    page: "admin-home",
  },
  { name: "Usuarios", href: "/admin/users", icon: "users", page: "users" },
  { name: "Roles", href: "/admin/roles", icon: "shield", page: "roles" },
];
---

<!-- Mobile Menu Button -->
<button
  id="mobile-menu-button"
  type="button"
  class="fixed top-4 left-4 z-50 lg:hidden p-2 rounded-lg bg-stone-900 shadow-lg border border-stone-800 text-stone-400 hover:text-white transition-colors"
  aria-label="Toggle menu"
>
  <svg
    id="menu-open-icon"
    class="w-6 h-6"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"
  >
    <path
      stroke-linecap="round"
      stroke-linejoin="round"
      stroke-width="2"
      d="M4 6h16M4 12h16M4 18h16"></path>
  </svg>
  <svg
    id="menu-close-icon"
    class="w-6 h-6 hidden"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"
  >
    <path
      stroke-linecap="round"
      stroke-linejoin="round"
      stroke-width="2"
      d="M6 18L18 6M6 6l12 12"></path>
  </svg>
</button>

<!-- Overlay -->
<div
  id="sidebar-overlay"
  class="fixed inset-0 bg-black/80 backdrop-blur-sm z-30 lg:hidden hidden transition-opacity"
>
</div>

<!-- Sidebar -->
<section
  id="sidebar"
  class="fixed top-0 left-0 z-40 h-screen w-60 bg-stone-900 border-r border-stone-800 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out"
>
  <div class="flex flex-col h-full">
    <!-- Logo/Header -->
    <div
      class="flex items-center justify-between p-6 border-b border-stone-800"
    >
      <div class="flex items-center gap-3">
        <img
          src="/logo.png"
          alt="Capyte"
          class="w-10 h-10 rounded-xl shadow-lg shadow-amber-900/20 bg-white"
        />
        <div>
          <h2 class="text-lg font-bold text-stone-100">Capyte Admin</h2>
          <p class="text-xs text-stone-500">Administración</p>
        </div>
      </div>
      <!-- Close button (mobile only) -->
      <button
        id="sidebar-close-button"
        class="lg:hidden p-1 rounded hover:bg-stone-800 text-stone-500 hover:text-stone-300"
        aria-label="Cerrar menú"
      >
        <svg
          class="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Navigation -->
    <nav class="flex-1 overflow-y-auto p-3">
      <div class="mb-6">
        <p
          class="px-4 text-xs font-semibold text-stone-500 uppercase tracking-wider mb-2"
        >
          Administración
        </p>
        <ul class="space-y-1">
          {
            adminItems.map((item) => (
              <li>
                <a
                  href={item.href}
                  class={`flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 ${
                    activePage === item.page
                      ? "bg-amber-500/10 text-amber-500 font-medium shadow-sm border border-amber-500/10"
                      : "text-stone-400 hover:bg-stone-800 hover:text-stone-200 border border-transparent"
                  }`}
                >
                  {item.icon === "dashboard" && (
                    <svg
                      class="w-5 h-5"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"
                      />
                    </svg>
                  )}
                  {item.icon === "users" && (
                    <svg
                      class="w-5 h-5"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"
                      />
                    </svg>
                  )}
                  {item.icon === "shield" && (
                    <svg
                      class="w-5 h-5"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"
                      />
                    </svg>
                  )}
                  <span>{item.name}</span>
                </a>
              </li>
            ))
          }
        </ul>
      </div>

      <div class="border-t border-stone-800 pt-3">
        <p
          class="px-4 text-xs font-semibold text-stone-500 uppercase tracking-wider mb-2"
        >
          Navegación
        </p>
        <ul class="space-y-1">
          <li>
            <a
              href="/dashboard"
              class="flex items-center gap-3 px-4 py-3 rounded-xl text-stone-400 hover:bg-stone-800 hover:text-stone-200 transition-colors border border-transparent"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
              </svg>
              <span>Ir al Dashboard</span>
            </a>
          </li>
        </ul>
      </div>
    </nav>

    <!-- User Section -->
    <div class="flex gap-2 justify-between items-center py-3 px-3 border-t border-stone-100 w-full">
      <a
        href="/dashboard/settings"
        aria-label="Ajustes del perfil"
        title="Ajustes del perfil"
        class="flex flex-1 items-center gap-3 p-3 rounded-2xl bg-stone-50 hover:bg-stone-100 transition-colors cursor-pointer group"
      >
        <div class="flex-1 min-w-0">
          <p class="text-sm font-bold text-stone-900 truncate">{name}</p>
          <p class="text-xs text-stone-500 truncate">{role}</p>
        </div>
      </a>
      <a
        href="/auth/logout"
        aria-label="Cerrar Sesión"
        title="Cerrar Sesión"
        class="flex items-center justify-center text-red-600 py-3 px-3 rounded-xl bg-red-100 hover:text-white hover:bg-red-600 transition-colors cursor-pointer"
        >
          <svg class="size-4" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
            <path d="m 8 0 c -0.550781 0 -1 0.449219 -1 1 v 5 c 0 0.550781 0.449219 1 1 1 s 1 -0.449219 1 -1 v -5 c 0 -0.550781 -0.449219 -1 -1 -1 z m -3.136719 1.816406 c -0.128906 0.015625 -0.253906 0.058594 -0.367187 0.125 c -2.734375 1.582032 -4.074219 4.816406 -3.257813 7.871094 c 0.820313 3.050781 3.59375 5.183594 6.75 5.1875 c 3.160157 0.003906 5.941407 -2.121094 6.765625 -5.167969 c 0.828125 -3.050781 -0.5 -6.289062 -3.230468 -7.878906 c -0.476563 -0.28125 -1.089844 -0.121094 -1.367188 0.359375 c -0.132812 0.226562 -0.171875 0.5 -0.105469 0.757812 c 0.070313 0.257813 0.234375 0.476563 0.464844 0.609376 c 1.957031 1.140624 2.902344 3.441406 2.3125 5.628906 c -0.59375 2.183594 -2.570313 3.695312 -4.832031 3.691406 c -2.265625 -0.003906 -4.238282 -1.519531 -4.824219 -3.707031 s 0.363281 -4.488281 2.324219 -5.621094 c 0.476562 -0.277344 0.640625 -0.886719 0.363281 -1.363281 c -0.132813 -0.230469 -0.347656 -0.398438 -0.605469 -0.464844 c -0.125 -0.035156 -0.257812 -0.042969 -0.390625 -0.027344 z m 0 0" fill="currentColor"/>
          </svg>
        </a>
    </div>
  </div>
</section>

<script>
  const sidebar = document.getElementById("sidebar");
  const overlay = document.getElementById("sidebar-overlay");
  const menuButton = document.getElementById("mobile-menu-button");
  const closeButton = document.getElementById("sidebar-close-button");
  const menuOpenIcon = document.getElementById("menu-open-icon");
  const menuCloseIcon = document.getElementById("menu-close-icon");

  function openSidebar() {
    sidebar?.classList.remove("-translate-x-full");
    overlay?.classList.remove("hidden");
    menuOpenIcon?.classList.add("hidden");
    menuCloseIcon?.classList.remove("hidden");
    document.body.style.overflow = "hidden";
  }

  function closeSidebar() {
    sidebar?.classList.add("-translate-x-full");
    overlay?.classList.add("hidden");
    menuOpenIcon?.classList.remove("hidden");
    menuCloseIcon?.classList.add("hidden");
    document.body.style.overflow = "";
  }

  menuButton?.addEventListener("click", () => {
    if (sidebar?.classList.contains("-translate-x-full")) {
      openSidebar();
    } else {
      closeSidebar();
    }
  });

  closeButton?.addEventListener("click", closeSidebar);
  overlay?.addEventListener("click", closeSidebar);

  const sidebarLinks = sidebar?.querySelectorAll("a");
  sidebarLinks?.forEach((link) => {
    link.addEventListener("click", () => {
      if (window.innerWidth < 1024) {
        closeSidebar();
      }
    });
  });

  document.addEventListener("keydown", (e) => {
    if (
      e.key === "Escape" &&
      !sidebar?.classList.contains("-translate-x-full")
    ) {
      closeSidebar();
    }
  });

  window.addEventListener("resize", () => {
    if (window.innerWidth >= 1024) {
      closeSidebar();
    }
  });
</script>
