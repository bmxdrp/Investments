---
import Layout from "@layouts/default.astro";
import { 
  getDashboardData, 
  getLatestExchangeRate, 
  formatCurrency 
} from "@lib/finance";

const ext = await getLatestExchangeRate();
const currentUsdRate = ext?.usd_to_cop || 3900;

const {userId} = Astro.locals;

if (!userId) {
  return Astro.redirect("/auth/login?returnTo=/");
}

// Obtener datos del dashboard
let data: any;
try {
  data = await getDashboardData(userId);
} catch (error) {
  console.error("Dashboard connection error:", error);
}


const total = data.totalPortfolioCurrentCOP || 0;

// Configuración visual por moneda
const currencyConfig: Record<
  string,
  { gradient: string; label: string }
> = {
  USD: {
    label: "USD",
    gradient: "bg-gradient-to-r from-green-400 to-green-600",
  },
  COP: {
    label: "COP",
    gradient: "bg-gradient-to-r from-blue-400 to-blue-600",
  },
};

// Normalizar, calcular porcentaje y ordenar dinámicamente
const distribution = (data.currencyDistribution || [])
  .map((item) => {
    const percentage =
      total > 0 ? (item.total_value_cop / total) * 100 : 0;

    return {
      ...item,
      percentage,
      label: currencyConfig[item.currency]?.label ?? item.currency,
      gradient:
        currencyConfig[item.currency]?.gradient ??
        "bg-gradient-to-r from-gray-400 to-gray-600",
    };
  })
  .sort((a, b) => b.percentage - a.percentage);
---

<Layout title="Dashboard" activePage="Dashboard">
  <div class="max-w-7xl mx-auto space-y-6">
    <!-- Header -->
    <div>
      <h1 class="text-3xl font-bold text-gray-900">Dashboard</h1>
      <p class="text-gray-600 mt-1">Resumen de tu portafolio de inversión</p>
    </div>

    <!-- Stats Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <!-- Total Portafolio -->
      <div
        class="bg-linear-to-br from-blue-500 to-blue-600 rounded-xl p-6 text-white shadow-lg"
      >
        <div class="flex items-center justify-between mb-2">
          <p class="text-sm font-medium opacity-90">Valor Total</p>
          <svg
            class="w-5 h-5 opacity-90"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            ></path>
          </svg>
        </div>
        <p class="text-3xl font-bold mb-1">
          ${formatCurrency(data.totalPortfolioCurrentCOP, "COP")}
        </p>
        <p class="text-xs opacity-75">COP</p>
      </div>

      <!-- Retorno Neto -->
      <div
        class={`rounded-xl p-6 shadow-lg ${
          data.returnsCurrent.netReturn >= 0
            ? "bg-linear-to-br from-green-500 to-green-600"
            : "bg-linear-to-br from-red-500 to-red-600"
        } text-white`}
      >
        <div class="flex items-center justify-between mb-2">
          <p class="text-sm font-medium opacity-90">Retorno Neto</p>
          <svg
            class="w-5 h-5 opacity-90"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
          </svg>
        </div>
        <p class="text-3xl font-bold mb-1">
          ${formatCurrency(data.returnsCurrent.netReturn, "COP")}
        </p>
        <p class="text-xs opacity-75 flex items-center gap-1 justify-center">
          Rentabilidad
          <span class="group relative cursor-help">
            <svg
              class="w-3 h-3"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              ></path>
            </svg>
            <span
              class="invisible group-hover:visible absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-48 bg-slate-800 text-white text-xs rounded p-2 z-10"
            >
              Porcentaje de ganancia o pérdida sobre el capital invertido
            </span>
          </span>
          : {data.returnsCurrent.returnPercentage}%
        </p>
      </div>

      <!-- Aportes del Mes -->
      <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
        <div class="flex items-center justify-between mb-2">
          <p class="text-sm font-medium text-gray-600">Aportes (Mes)</p>
          <svg
            class="w-5 h-5 text-green-500"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 4v16m8-8H4"></path>
          </svg>
        </div>
        <p class="text-2xl font-bold text-gray-900">
          ${formatCurrency(data.monthly.contributions, "COP")}
        </p>
        <p class="text-xs text-gray-500">COP</p>
      </div>

      <!-- Retiros del Mes -->
      <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
        <div class="flex items-center justify-between mb-2">
          <p class="text-sm font-medium text-gray-600">Retiros (Mes)</p>
          <svg
            class="w-5 h-5 text-red-500"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M20 12H4"></path>
          </svg>
        </div>
        <p class="text-2xl font-bold text-gray-900">
          ${formatCurrency(data.monthly.withdrawals, "COP")}
        </p>
        <p class="text-xs text-gray-500">COP</p>
      </div>
    </div>

    <!-- Cuentas y Distribución -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Lista de Cuentas (2/3) -->
      <div class="order-1 lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-200 p-6" data-animate>
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold text-gray-900">Mis Cuentas</h2>
          <a
            href="/dashboard/accounts"
            class="text-sm text-blue-600 hover:text-blue-700 font-medium"
          >
            Gestionar →
          </a>
        </div>

        <div class="space-y-4">
          {
            data.accounts.map((acc: any) => (
              <div class="border border-gray-200 rounded-lg p-3">
                {/* Cuenta Principal */}
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-4 flex-1 min-w-0">
                    <div class="p-2 bg-blue-100 rounded-lg shrink-0">
                      <svg
                        class="size-5 text-blue-600"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
                        />
                      </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                      <p class="font-bold text-gray-700 truncate">{acc.name}</p>
                      <p class="text-sm text-gray-500">
                        {acc.type} · {acc.currency}
                        {acc.subaccounts.length > 0 &&
                          ` · ${acc.subaccounts.length} subcuentas`}
                      </p>
                    </div>
                  </div>
                  <div class="text-right">
                    <p class="font-bold text-gray-900 whitespace-nowrap">
                      {formatCurrency(acc.total_with_subs, acc.currency)}{" "}
                      {acc.currency}
                    </p>
                    <p class="text-xs text-gray-500">
                      {acc.currency === "USD"
                        ? `${formatCurrency(acc.total_with_subs_cop, "COP")} COP`
                        : `${formatCurrency(acc.total_with_subs / currentUsdRate, "USD")} USD`}
                    </p>
                  </div>
                </div>

                {/* Subcuentas */}
                {acc.subaccounts.length > 0 && (
                  <div class="mt-2 grid grid-cols-1 lg:grid-cols-3 gap-1.5">
                    {acc.subaccounts.map((sub: any) => (
                      <div class="flex items-center justify-between px-4 py-2 bg-gray-50 rounded-lg">
                        <div class="flex items-center gap-2 flex-1 min-w-0">
                          {/* <svg
                            class="w-4 h-4 text-gray-500 shrink-0"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                            />
                          </svg> */}
                          <div class="flex-1 min-w-0">
                            <p class="font-semibold text-gray-900 text-sm truncate">
                              {sub.name}
                            </p>
                            <p class="text-xs text-gray-500">{sub.type}</p>
                          </div>
                        </div>
                        <div class="text-right">
                          <p class="font-semibold text-gray-900 text-sm whitespace-nowrap">
                            {formatCurrency(sub.latest_value, sub.currency)}{" "}
                            {sub.currency}
                          </p>
                          <p class="text-xs text-gray-500">
                            {sub.currency === "USD"
                              ? `${formatCurrency(sub.latest_value_cop, "COP")} COP`
                              : `${formatCurrency(sub.latest_value / currentUsdRate, "USD")} USD`}
                          </p>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            ))
          }
        </div>

        {
          data.accounts.length === 0 && (
            <div class="text-center py-12">
              <svg
                class="w-16 h-16 text-gray-300 mx-auto mb-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
                />
              </svg>
              <p class="text-gray-500 mb-4">No tienes cuentas registradas</p>
              <a
                href="/dashboard/accounts"
                class="inline-block px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
              >
                Crear Primera Cuenta
              </a>
            </div>
          )
        }
      </div>

      <!-- Distribución por Moneda (1/3) -->
<div class="order-2 lg:col-span-1 bg-white rounded-xl max-h-44 h-auto shadow-sm border border-gray-200 p-6" data-animate>
  <h2 class="text-xl font-bold text-gray-900 mb-6">Distribución</h2>

  {distribution.length > 0 ? (
    <div>
      <!-- Leyenda -->
      <div class="flex flex-wrap gap-6 mb-4">
        {distribution.map((item: any) => (
          <div class="flex items-center gap-2 text-sm">
            <span class={`w-3 h-3 rounded-full ${item.gradient}`}></span>
            <span class="text-gray-700 font-medium">{item.label}</span>
            <span class="text-gray-900 font-semibold">
              {item.percentage.toFixed(2)}%
            </span>
          </div>
        ))}
      </div>

      <!-- Barra apilada -->
      <div class="relative w-full h-3 bg-gray-200 rounded-full overflow-hidden flex">
        {distribution.map((item: any) => (
          <div
            class={`
              distribution-segment
              h-full
              ${item.gradient}
              transition-all
              duration-1000
              ease-out
            `}
            style={`width: ${item.percentage}%`}
            data-label={item.label}
            data-value={item.total_value_cop}
            data-percent={item.percentage.toFixed(2)}
          />
        ))}
      </div>

      <!-- Valores -->
      <div class="flex justify-between text-xs text-gray-500 mt-3">
        {distribution.map((item: any) => (
          <span>
            {item.label}: ${formatCurrency(item.total_value_cop, "COP")} COP
          </span>
        ))}
      </div>
    </div>
  ) : (
    <p class="text-center text-sm text-gray-500 py-8">
      No hay datos disponibles
    </p>
  )}
</div>
    
    <!-- Movimientos Recientes -->
    <div class="order-3 lg:col-span-3 bg-white rounded-xl shadow-sm border border-gray-200 p-6" data-animate>
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold text-gray-900">Movimientos Recientes</h2>
        <a
          href="/dashboard/history"
          class="text-sm text-blue-600 hover:text-blue-700 font-medium"
        >
          Ver todos →
        </a>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="border-b border-gray-200">
              <th
                class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider pb-3"
                >Tipo</th
              >
              <th
                class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider pb-3"
                >Monto</th
              >
              <th
                class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider pb-3"
                >Fecha</th
              >
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            {
              data.movements.slice(0, 10).map((mov: any) => {
                type TransactionType =
                  | "contribution"
                  | "withdrawal"
                  | "gain"
                  | "loss"
                  | "adjustment"
                  | "initial_balance"
                  | "transfer_in"
                  | "transfer_out"
                  | "dividend"
                  | "interest"
                  | "fee";

                const typeColors: { [key: string]: string } = {
                  contribution: "bg-green-100 text-green-700",
                  withdrawal: "bg-red-100 text-red-700",
                  gain: "bg-blue-100 text-blue-700",
                  loss: "bg-orange-100 text-orange-700",
                  adjustment: "bg-purple-100 text-purple-700",
                  initial_balance: "bg-gray-100 text-gray-700",
                  transfer_in: "bg-indigo-100 text-indigo-700",
                  transfer_out: "bg-pink-100 text-pink-700",
                  dividend: "bg-teal-100 text-teal-700",
                  interest: "bg-cyan-100 text-cyan-700",
                  fee: "bg-amber-100 text-amber-700",
                };

                const typeLabels: { [key: string]: string } = {
                  contribution: "Aporte",
                  withdrawal: "Retiro",
                  gain: "Ganancia",
                  loss: "Caida",
                  adjustment: "Ajuste",
                  initial_balance: "Saldo Inicial",
                  transfer_in: "Entrada",
                  transfer_out: "Salida",
                  dividend: "Dividendo",
                  interest: "Interés",
                  fee: "Comisión",
                };

                return (
                  <tr class="hover:bg-gray-50">
                    <td class="py-3">
                      <span
                        class={`px-2 py-1 rounded-full text-xs font-medium ${typeColors[mov.type as string] || "bg-gray-100 text-gray-700"}`}
                      >
                        {typeLabels[mov.type as string] || mov.type}
                      </span>
                    </td>
                    <td class="py-3">
                      <span class="font-semibold text-gray-900">
                        {formatCurrency((mov.difference), mov.currency)}{" "}
                        {mov.currency}
                      </span>
                    </td>
                    <td class="py-3 text-sm text-gray-600">
                      {new Date(mov.date).toLocaleDateString("es-CO", {
                        year: "numeric",
                        month: "short",
                        day: "numeric",
                      })}
                    </td>
                  </tr>
                );
              })
            }
          </tbody>
        </table>
      </div>

      {
        data.movements.length === 0 && (
          <div class="text-center py-12">
            <svg
              class="w-16 h-16 text-gray-300 mx-auto mb-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
              />
            </svg>
            <p class="text-gray-500 mb-4">No hay movimientos registrados</p>
            <a
              href="/dashboard/contribute"
              class="inline-block px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
            >
              Registrar Primer Movimiento
            </a>
          </div>
        )
      }
    </div>
    </div>
  </div>
</Layout>

<style>
  /* Animaciones suaves */
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .space-y-4 > * {
    animation: slideIn 0.3s ease-out;
  }
</style>

<script is:inline>
  // Animación al hacer scroll
  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          entry.target
            .querySelectorAll(".distribution-segment")
            .forEach((segment) => {
              segment.style.width = segment.style.width;
            });
        }
      });
    },
    { threshold: 0.4 }
  );

  document
    .querySelectorAll("[data-animate]")
    .forEach((el) => observer.observe(el));
</script>
