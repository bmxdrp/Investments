---
import Layout from "@layouts/default.astro";
import { sql } from "@lib/db";
import { getCategories } from "@lib/categories";
import CsrfField from "@components/CsrfField.astro";

const {userId} = Astro.locals;

if (!userId) {
  return Astro.redirect("/auth/login?returnTo=/dashboard/contribute");
}

const { searchParams } = Astro.url;
const contributionSuccess = searchParams.get("contribution_success");
const error = searchParams.get("error");

// Obtener cuentas disponibles
const accounts = await sql`
  SELECT id, name, currency
  FROM accounts
  WHERE currency IN ('COP', 'USD')
  AND user_id = ${userId}
  ORDER BY name ASC;
`;

// Obtener categorías de tipo 'income' (aportes)
const categories = await getCategories("income");

// Fecha actual por defecto
const today = new Date().toLocaleDateString("en-CA", {
  timeZone: "America/Bogota",
});
---

<Layout title="Agregar Inversión" activePage="Aportes" name={name} user_type={userRole}>
  <div class="max-w-2xl mx-auto space-y-6">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 tracking-tight">
        Registrar Aporte
      </h1>
      <p class="mt-2 text-gray-500">Controla el crecimiento de tu capital</p>
    </div>

    <!-- Mensajes de éxito/error -->
    {
      contributionSuccess === "1" && (
        <div class="mb-6 bg-emerald-50 border border-emerald-100 rounded-xl p-4 animate-fade-in-down">
          <div class="flex items-center">
            <div class="flex-shrink-0 bg-emerald-100 rounded-full p-1.5">
              <svg
                class="h-5 w-5 text-emerald-600"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fill-rule="evenodd"
                  d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                  clip-rule="evenodd"
                />
              </svg>
            </div>
            <div class="ml-3">
              <p class="text-sm font-semibold text-emerald-800">
                ¡Aporte registrado correctamente!
              </p>
            </div>
          </div>
        </div>
      )
    }

    {
      contributionSuccess === "0" && (
        <div class="mb-6 bg-red-50 border border-red-100 rounded-xl p-4">
          <div class="flex items-center">
            <div class="flex-shrink-0 bg-red-100 rounded-full p-1.5">
              <svg
                class="h-5 w-5 text-red-600"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fill-rule="evenodd"
                  d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                  clip-rule="evenodd"
                />
              </svg>
            </div>
            <div class="ml-3">
              <p class="text-sm font-medium text-red-800">
                No se pudo registrar
              </p>
              {error && (
                <p class="text-xs text-red-600 mt-1">
                  {decodeURIComponent(error)}
                </p>
              )}
            </div>
          </div>
        </div>
      )
    }

    <!-- Formulario de inversión -->
    <div
      class="bg-white shadow-sm rounded-2xl border border-gray-100 overflow-hidden"
    >
      <form
        method="POST"
        action="/api/transactions/contribute"
        class="p-6 md:p-8 space-y-6"
      >
        <CsrfField />

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Cuenta -->
          <div class="col-span-1 md:col-span-2">
            <label
              for="account_id"
              class="block text-sm font-medium text-gray-700 mb-2"
              >Destino</label
            >
            <div class="relative">
              <select
                id="account_id"
                name="account_id"
                required
                class="appearance-none w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition text-gray-900 font-medium"
              >
                <option value="">Selecciona una cuenta...</option>
                {
                  accounts.map((account) => (
                    <option value={account.id}>
                      {account.name} · {account.currency}
                    </option>
                  ))
                }
              </select>
              <div
                class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500"
              >
                <svg
                  class="h-4 w-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 9l-7 7-7-7"></path></svg
                >
              </div>
            </div>
          </div>

          <!-- Categoría -->
          <div class="col-span-1 md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-3"
              >Categoría</label
            >
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
              {
                categories.map((cat) => (
                  <label class="cursor-pointer">
                    <input
                      type="radio"
                      name="category_id"
                      value={cat.id}
                      class="peer sr-only"
                      required
                    />
                    <div class="flex items-center gap-3 p-3 rounded-xl border border-gray-200 bg-white hover:bg-gray-50 peer-checked:border-blue-500 peer-checked:ring-1 peer-checked:ring-blue-500 peer-checked:bg-blue-50/50 transition-all">
                      <span class="text-xl">{cat.icon}</span>
                      <span class="text-sm font-medium text-gray-700">
                        {cat.name}
                      </span>
                    </div>
                  </label>
                ))
              }
            </div>
          </div>

          <!-- Monto -->
          <div>
            <label
              for="amount"
              class="block text-sm font-medium text-gray-700 mb-2">Monto</label
            >
            <div class="relative">
              <span class="absolute left-4 top-3.5 text-gray-400">$</span>
              <input
                type="number"
                id="amount"
                name="amount"
                step="0.01"
                min="0.01"
                placeholder="0.00"
                required
                class="w-full pl-8 pr-4 py-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition text-lg font-bold text-gray-900 placeholder:text-gray-300"
              />
            </div>
          </div>

          <!-- Moneda -->
          <div>
            <label
              for="currency"
              class="block text-sm font-medium text-gray-700 mb-2">Moneda</label
            >
            <div class="relative">
              <select
                id="currency"
                name="currency"
                required
                class="appearance-none w-full px-4 py-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition text-gray-900 font-medium"
              >
                <option value="COP">COP (Peso)</option>
                <option value="USD">USD (Dólar)</option>
              </select>
              <div
                class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500"
              >
                <svg
                  class="h-4 w-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 9l-7 7-7-7"></path></svg
                >
              </div>
            </div>
          </div>

          <!-- Fecha -->
          <div class="col-span-1 md:col-span-2">
            <label
              for="date"
              class="block text-sm font-medium text-gray-700 mb-2">Fecha</label
            >
            <input
              type="date"
              id="date"
              name="date"
              value={today}
              required
              class="w-full px-4 py-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition text-gray-900 font-medium"
            />
          </div>

          <!-- Nota -->
          <div class="col-span-1 md:col-span-2">
            <label
              for="note"
              class="block text-sm font-medium text-gray-700 mb-2"
              >Nota (Opcional)</label
            >
            <textarea
              id="note"
              name="note"
              rows="2"
              placeholder="Detalles de la transacción..."
              class="w-full px-4 py-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition text-gray-900 font-medium resize-none placeholder:text-gray-300"
            ></textarea>
          </div>
        </div>

        <!-- Botones -->
        <div class="flex items-center gap-4 pt-4">
          <a
            href="/dashboard"
            class="flex-1 text-center text-gray-600 px-6 py-3 rounded-xl font-medium hover:bg-gray-50 hover:text-gray-900 transition"
          >
            Cancelar
          </a>
          <button
            type="submit"
            class="flex-[2] bg-blue-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-blue-600/20 hover:bg-blue-700 hover:shadow-blue-600/30 transition-all transform hover:-translate-y-0.5 active:translate-y-0"
          >
            Confirmar Aporte
          </button>
        </div>
      </form>
    </div>
  </div>
</Layout>

<style>
  @keyframes fadeInDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  .animate-fade-in-down {
    animation: fadeInDown 0.4s ease-out;
  }
</style>
