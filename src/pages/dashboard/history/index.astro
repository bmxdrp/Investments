---
import Layout from "@layouts/default.astro";
import { sql } from "@lib/db";
import { getLatestExchangeRate } from "@lib/finance";

const {userId} = Astro.locals;

if (!userId) {
  return Astro.redirect("/auth/login?returnTo=/dashboard/history");
}

// Obtener tasa de cambio actual para fallback
const latestRateData = await getLatestExchangeRate();
const currentRate = latestRateData?.usd_to_cop || 4000;

// Obtener todos los movimientos de la tabla transactions
// Se eliminó el filtro de tipos para mostrar TODO
const movements = await sql`
  SELECT 
    t.type,
    t.date,
    t.amount,
    t.notes as note,
    a.name as account_name,
    coalesce(t.new_value - t.previous_value, 0) as change,
    t.currency,
    t.usd_to_cop_rate,
    TO_CHAR(t.date, 'YYYY-MM') as month_key
  FROM transactions t
  JOIN accounts a ON t.account_id = a.id
  WHERE a.user_id = ${userId}
  ORDER BY t.date DESC, t.created_at DESC
`;

// Agrupar movimientos por mes
const movementsByMonth = movements.reduce((acc, mov) => {
  const monthKey = mov.month_key;
  if (!acc[monthKey]) {
    // Crear label en español usando la primera fecha del mes
    const date = new Date(mov.date);
    // Ajustar zona horaria para evitar desfases de mes
    const monthLabel = date.toLocaleDateString('es-CO', { month: 'long', year: 'numeric', timeZone: 'UTC' });
    
    acc[monthKey] = {
      label: monthLabel,
      movements: [],
      totalContributions: 0,
      totalWithdrawals: 0
    };
  }
  
  acc[monthKey].movements.push(mov);
  
  // Calcular monto en COP para totales
  const rate = Number(mov.usd_to_cop_rate) || currentRate;
  const amountInCOP = mov.currency === 'USD' ? Number(mov.amount) * rate : Number(mov.amount);
  
  // Calcular totales por mes (solo flujos externos)
  if (mov.type === 'contribution' || mov.type === 'initial_balance') {
    acc[monthKey].totalContributions += amountInCOP;
  } else if (mov.type === 'withdrawal') {
    acc[monthKey].totalWithdrawals += amountInCOP;
  }
  
  return acc;
}, {} as Record<string, any>);

// Convertir a array y ordenar por mes (más reciente primero)
const monthsArray = Object.entries(movementsByMonth)
  .sort(([a], [b]) => b.localeCompare(a))
  .map(([key, data]) => ({ key, ...data }));

// Calcular totales generales (solo flujos externos)
const totalContributions = movements
  .filter(m => m.type === 'contribution' || m.type === 'initial_balance')
  .reduce((sum, m) => {
    const rate = Number(m.usd_to_cop_rate) || currentRate;
    const amountInCOP = m.currency === 'USD' ? Number(m.amount) * rate : Number(m.amount);
    return sum + amountInCOP;
  }, 0);

const totalWithdrawals = movements
  .filter(m => m.type === 'withdrawal')
  .reduce((sum, m) => {
    const rate = Number(m.usd_to_cop_rate) || currentRate;
    const amountInCOP = m.currency === 'USD' ? Number(m.amount) * rate : Number(m.amount);
    return sum + amountInCOP;
  }, 0);

const netMovement = totalContributions - totalWithdrawals;

// Helper para formatear moneda
const formatCurrency = (amount: number, currency: string) => {
  return amount.toLocaleString('es-CO', { 
    style: 'currency', 
    currency: currency, 
    minimumFractionDigits: 1,
    maximumFractionDigits: 2 
  });
};

// Helper para obtener etiqueta legible del tipo
const getTypeLabel = (type: string) => {
  switch(type) {
    case 'contribution': return 'Aporte';
    case 'withdrawal': return 'Retiro';
    case 'transfer_in': return 'Transferencia Recibida';
    case 'transfer_out': return 'Transferencia Enviada';
    case 'adjustment': return 'Ajuste de Valor';
    case 'initial_balance': return 'Saldo Inicial';
    case 'gain': return 'Ganancia';
    case 'loss': return 'Caida';
    case 'dividend': return 'Dividendo';
    case 'interest': return 'Interés';
    case 'fee': return 'Comisión';
    default: return type;
  }
};
---

<Layout title="Historial de Movimientos" activePage="Historial">
      <div class="max-w-6xl mx-auto space-y-4 sm:space-y-6">
        <!-- Header -->
        <div class="mb-4 sm:mb-6">
          <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Historial de Movimientos</h1>
          <p class="text-sm sm:text-base text-gray-600 mt-1">Registro completo de aportes, retiros, transferencias y ajustes.</p>
        </div>

        <!-- Summary Cards (Solo flujos externos) -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
          <!-- Total Contributions -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 sm:p-6">
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <p class="text-xs sm:text-sm font-medium text-gray-600">Total Aportado</p>
                <p class="text-lg sm:text-2xl font-bold text-green-600 mt-1 sm:mt-2">
                  {formatCurrency(totalContributions, 'COP')}
                </p>
                <p class="text-xs text-gray-500 mt-1">Dinero ingresado (aprox. en COP)</p>
              </div>
              <div class="p-2 sm:p-3 bg-green-100 rounded-lg shrink-0">
                <svg class="w-6 h-6 sm:w-8 sm:h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12"/>
                </svg>
              </div>
            </div>
          </div>

          <!-- Total Withdrawals -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 sm:p-6">
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <p class="text-xs sm:text-sm font-medium text-gray-600">Total Retirado</p>
                <p class="text-lg sm:text-2xl font-bold text-red-600 mt-1 sm:mt-2">
                  {formatCurrency(totalWithdrawals, 'COP')}
                </p>
                <p class="text-xs text-gray-500 mt-1">Dinero extraído (aprox. en COP)</p>
              </div>
              <div class="p-2 sm:p-3 bg-red-100 rounded-lg shrink-0">
                <svg class="w-6 h-6 sm:w-8 sm:h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 13l-5 5m0 0l-5-5m5 5V6"/>
                </svg>
              </div>
            </div>
          </div>

          <!-- Net Movement -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 sm:p-6 sm:col-span-2 lg:col-span-1">
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <p class="text-xs sm:text-sm font-medium text-gray-600">Flujo Neto</p>
                <p class={`text-lg sm:text-2xl font-bold mt-1 sm:mt-2 ${netMovement >= 0 ? 'text-blue-600' : 'text-orange-600'}`}>
                  {netMovement >= 0 ? '+' : ''}{formatCurrency(netMovement, 'COP')}
                </p>
                <p class="text-xs text-gray-500 mt-1">Aportes - Retiros</p>
              </div>
              <div class={`p-2 sm:p-3 rounded-lg shrink-0 ${netMovement >= 0 ? 'bg-blue-100' : 'bg-orange-100'}`}>
                <svg class={`w-6 h-6 sm:w-8 sm:h-8 ${netMovement >= 0 ? 'text-blue-600' : 'text-orange-600'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
              </div>
            </div>
          </div>
        </div>

        <!-- Movements by Month -->
        <div class="space-y-4 sm:space-y-6">
          {monthsArray.map(month => {
            const netMonth = month.totalContributions - month.totalWithdrawals;
            return (
              <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <!-- Month Header -->
                <div class="bg-linear-to-r from-slate-800 to-slate-700 px-4 sm:px-6 py-3 sm:py-4">
                  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 sm:gap-0">
                    <div>
                      <h3 class="text-lg sm:text-xl font-bold text-white capitalize">
                        {month.label}
                      </h3>
                      <p class="text-slate-300 text-xs sm:text-sm mt-0.5 sm:mt-1">
                        {month.movements.length} {month.movements.length === 1 ? 'movimiento' : 'movimientos'}
                      </p>
                    </div>
                    <div class="sm:text-right">
                      <p class="text-xs sm:text-sm text-slate-300">Flujo de Caja Neto</p>
                      <p class={`text-xl sm:text-2xl font-bold ${netMonth >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                        {netMonth >= 0 ? '+' : ''}{formatCurrency(netMonth, 'COP')}
                      </p>
                    </div>
                  </div>
                </div>

                <!-- Movements List -->
                <div class="divide-y divide-gray-100">
                  {month.movements.map((mov: any) => {
                    // Determinar estilos según tipo
                    let iconBg = 'bg-gray-100';
                    let iconColor = 'text-gray-600';
                    let amountColor = 'text-gray-900';
                    let sign = '';
                    let iconPath = '';

                    switch(mov.type) {
                      case 'contribution':
                      case 'initial_balance':
                        iconBg = 'bg-green-100';
                        iconColor = 'text-green-600';
                        amountColor = 'text-green-600';
                        sign = '';
                        iconPath = 'M7 11l5-5m0 0l5 5m-5-5v12';
                        break;
                      case 'withdrawal':
                        iconBg = 'bg-red-100';
                        iconColor = 'text-red-600';
                        amountColor = 'text-red-600';
                        sign = '';
                        iconPath = 'M17 13l-5 5m0 0l-5-5m5 5V6';
                        break;
                      case 'transfer_in':
                        iconBg = 'bg-blue-100';
                        iconColor = 'text-blue-600';
                        amountColor = 'text-blue-600';
                        sign = '';
                        iconPath = 'M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4'; 
                        break;
                      case 'transfer_out':
                        iconBg = 'bg-orange-100';
                        iconColor = 'text-orange-600';
                        amountColor = 'text-orange-600';
                        sign = '';
                        iconPath = 'M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4';
                        break;
                      case 'adjustment':
                        iconBg = 'bg-gray-100';
                        iconColor = 'text-gray-600';
                        amountColor = 'text-gray-600';
                        sign = '';
                        iconPath = 'M20.75 7a1.25 1.25 0 1 1 0 2.5H3.25a1.25 1.25 0 0 1 0-2.5h17.5zM20.75 15.5a1.25 1.25 0 1 1 0 2.5H3.25a1.25 1.25 0 1 1 0-2.5h17.5z';
                        break;
                      case 'gain':
                        iconBg = 'bg-green-100';
                        iconColor = 'text-green-600';
                        amountColor = 'text-green-600';
                        sign = '';
                        iconPath = 'M7 11l5-5m0 0l5 5m-5-5v12';
                        break;
                      case 'loss':
                        iconBg = 'bg-orange-100';
                        iconColor = 'text-orange-600';
                        amountColor = 'text-orange-600';
                        sign = '';
                        iconPath = 'M17 13l-5 5m0 0l-5-5m5 5V6';
                        break;
                      case 'dividend':
                      case 'interest':
                      case 'fee':
                        iconBg = 'bg-gray-100';
                        iconColor = 'text-gray-600';
                        amountColor = 'text-gray-600';
                        sign = '';
                        iconPath = 'M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z'; 
                        break;
                      default:
                        iconBg = 'bg-gray-100';
                        iconColor = 'text-gray-600';
                        amountColor = 'text-gray-600';
                        sign = '';
                        iconPath = 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z';
                    }

                    return (
                    <div class="px-4 sm:px-6 py-3 sm:py-4 hover:bg-gray-50 transition">
                      <div class="flex items-start sm:items-center gap-3 sm:gap-4">
                        <!-- Icon -->
                        <div class={`p-2 sm:p-3 rounded-lg shrink-0 ${iconBg}`}>
                          <svg class={`w-4 h-4 sm:w-5 sm:h-5 ${iconColor}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d={iconPath}/>
                          </svg>
                        </div>

                        <!-- Details -->
                        <div class="flex-1 min-w-0">
                          <div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-3">
                            <p class="font-semibold text-sm sm:text-base text-gray-900 capitalize">
                              {getTypeLabel(mov.type)}
                            </p>
                            <span class="text-xs px-2 py-0.5 sm:py-1 bg-gray-100 text-gray-600 rounded-full font-medium w-fit">
                              {mov.account_name}
                            </span>
                          </div>
                          <div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-4 mt-1">
                            <p class="text-xs sm:text-sm text-gray-500">
                              {new Date(mov.date).toLocaleDateString('es-CO', { 
                                weekday: 'short',
                                year: 'numeric',
                                month: 'short',
                                day: 'numeric',
                                timeZone: 'UTC'
                              })}
                            </p>
                            {mov.note && (
                              <p class="text-xs sm:text-sm text-gray-500 italic truncate">
                                "{mov.note}"
                              </p>
                            )}
                          </div>
                        </div>

                        <!-- Amount -->
                        <div class="text-right shrink-0">
                          <p class={`text-base sm:text-xl font-bold ${amountColor}`}>
                            {sign}{Number(formatCurrency((mov.change), mov.currency))}
                          </p>
                          <p class="text-xs text-gray-500 mt-0.5 sm:mt-1">{mov.currency}</p>
                        </div>
                      </div>
                    </div>
                  )})}
                </div>
              </div>
            );
          })}
        </div>

        {monthsArray.length === 0 && (
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8 sm:p-12 text-center">
            <svg class="w-12 h-12 sm:w-16 sm:h-16 text-gray-300 mx-auto mb-3 sm:mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <h3 class="text-lg sm:text-xl font-semibold text-gray-900 mb-2">No hay movimientos registrados</h3>
            <p class="text-sm sm:text-base text-gray-600 mb-4 sm:mb-6">Comienza agregando tu primer aporte o retiro</p>
            <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 justify-center">
              <a href="/dashboard/contribute" class="px-6 py-2.5 sm:py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition text-sm sm:text-base">
                Agregar Fondos
              </a>
            </div>
          </div>
        )}
      </div>
</Layout>