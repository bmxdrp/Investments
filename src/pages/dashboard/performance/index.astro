---
// src/pages/dashboard/performance.astro
import Default from "@layouts/default.astro";
import { setRLSUser, sql } from "@lib/db";
import CsrfField from "@components/CsrfField.astro";

const {userId, name, user_type} = Astro.locals;
if (!userId) {
  return Astro.redirect("/auth/login?returnTo=/dashboard/performance");
}
await setRLSUser(userId);

// Obtener tasa de cambio actual
const latestRate = await sql`
  SELECT usd_to_cop, date
  FROM exchange_rates
  ORDER BY date DESC
  LIMIT 1
`;
const currentRate = latestRate.length > 0 ? Number(latestRate[0].usd_to_cop) : 1;

// ‚úÖ Obtener todas las cuentas con su √∫ltimo valor desde TRANSACTIONS (CUALQUIER TIPO)
const accountsWithValues = await sql`
  SELECT 
    a.id,
    a.name,
    a.type,
    a.currency,
    a.parent_account_id,

    COALESCE(
      (
        SELECT t.new_value
        FROM transactions t
        WHERE t.account_id = a.id
          AND t.user_id = ${userId}
        ORDER BY t.date DESC, t.created_at DESC, t.id DESC
        LIMIT 1
      ),
      0
    ) AS current_value,

    COALESCE(
      (
        SELECT t.previous_value
        FROM transactions t
        WHERE t.account_id = a.id
          AND t.user_id = ${userId}
        ORDER BY t.date DESC, t.created_at DESC, t.id DESC
        LIMIT 1
      ),
      0
    ) AS previous_value,

    COALESCE(
      (
        SELECT t.date
        FROM transactions t
        WHERE t.account_id = a.id
        ORDER BY t.date DESC, t.created_at DESC, t.id DESC
        LIMIT 1
      ),
      CURRENT_DATE
    ) AS last_update

  FROM accounts a
  WHERE a.user_id = ${userId}
  AND a.is_active = true
  ORDER BY 
    COALESCE(a.parent_account_id, a.id) ASC,
    CASE WHEN a.parent_account_id IS NULL THEN 0 ELSE 1 END ASC,
    a.name ASC
`;

// Agrupar cuentas principales y subcuentas
const accountsHierarchy = [];
const accountsMap = new Map();

for (const acc of accountsWithValues) {
  if (!acc.parent_account_id) {
    accountsMap.set(acc.id, { ...acc, subaccounts: [] });
    accountsHierarchy.push(accountsMap.get(acc.id));
  }
}

for (const acc of accountsWithValues) {
  if (acc.parent_account_id) {
    const parent = accountsMap.get(acc.parent_account_id);
    if (parent) {
      parent.subaccounts.push(acc);
    }
  }
}

// Ordenar subcuentas de mayor a menor valor (convertido a COP para comparaci√≥n justa)
for (const parent of accountsHierarchy) {
  parent.subaccounts.sort((a: any, b: any) => {
    const valueA = Number(a.current_value);
    const valueB = Number(b.current_value);
    return valueB - valueA; // Orden descendente
  });
}
// Calcular totales
let totalCOP = 0;
for (const acc of accountsWithValues) {
  const value = Number(acc.current_value);
  if (acc.currency === 'USD') {
    totalCOP += value * currentRate;
  } else {
    totalCOP += value;
  }
}

// Funci√≥n para calcular diferencia y porcentaje
function calculateDifference(currentValue: number, previousValue: number) {
  const diff = currentValue - previousValue;
  const percentChange = previousValue !== 0 ? ((diff / previousValue) * 100) : 0;
  return { diff, percentChange };
}

const todayColombia = new Date().toLocaleDateString("es-CO", {
  timeZone: "America/Bogota",
  year: "numeric",
  month: "2-digit",
  day: "2-digit"
}).split("/").reverse().join("-"); // YYYY-MM-DD
---

<Default title="Actualizar Valores" activePage="activity" name={name} user_type={user_type}>
  <div class="max-w-7xl mx-auto space-y-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Actualizar Valores</h1>
        <p class="text-gray-600 mt-1">
          Ingresa manualmente los valores actuales de tus cuentas
        </p>
      </div>
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
        <p class="text-sm text-gray-600">Valor Total del Portafolio</p>
        <p class="text-2xl font-bold text-gray-900">
          {totalCOP.toLocaleString('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 })}
        </p>
        <p class="text-xs text-gray-500 mt-1">
          Tasa USD: {currentRate.toLocaleString('es-CO')} COP
        </p>
      </div>
    </div>

    <!-- Mensaje de √©xito/error -->
    {Astro.url.searchParams.get('success') === '1' && (
      <div class="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg">
        ‚úÖ {Astro.url.searchParams.get('count') 
          ? `${Astro.url.searchParams.get('count')} cuentas actualizadas correctamente`
          : 'Valores actualizados correctamente'}
      </div>
    )}
    {Astro.url.searchParams.get('warning') && (
      <div class="bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-3 rounded-lg">
        ‚ö†Ô∏è {decodeURIComponent(Astro.url.searchParams.get('warning') || "")}
      </div>
    )}
    {Astro.url.searchParams.get('error') && (
      <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg">
        ‚ùå {decodeURIComponent(Astro.url.searchParams.get('error') || "Error al actualizar")}
      </div>
    )}

    <!-- Formulario √∫nico para todas las cuentas -->
    <form method="POST" action="/api/portfolio-values/batch" id="batch-update-form">
      <CsrfField />
      <input type="hidden" name="user_id" value={userId} />
      <input type="hidden" name="usd_to_cop_rate" value={currentRate} />
      
      <!-- Controles superiores -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-4">
        <div class="flex flex-col sm:flex-row gap-4 items-end">
          <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Fecha de actualizaci√≥n (aplicar√° a todas las cuentas)
            </label>
            <input
              type="date"
              name="batch_date"
              id="batch-date"
              value={todayColombia}
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          <div class="flex gap-3">
            <button
              type="button"
              id="select-all-btn"
              class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors font-medium whitespace-nowrap"
            >
              Seleccionar todas
            </button>
            <button
              type="submit"
              class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-medium whitespace-nowrap"
            >
              Guardar seleccionadas
            </button>
          </div>
        </div>
      </div>

      <!-- Lista de Cuentas -->
      <div class="space-y-4">
        {accountsHierarchy.map((account) => {
          const { diff, percentChange } = calculateDifference(
            Number(account.current_value), 
            Number(account.previous_value)
          );
          
          return (
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
              <!-- Cuenta Principal -->
              <div class="bg-gradient-to-r from-blue-50 to-blue-100 border-b border-blue-200 p-6">
                <div class="flex items-start gap-4">
                  <input
                    type="checkbox"
                    name="selected_accounts"
                    value={account.id}
                    id={`check-${account.id}`}
                    class="account-checkbox mt-1 w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                  />
                  
                  <div class="flex-1">
                    <div class="flex justify-between">
                      <div class="flex-1">
                        <label for={`check-${account.id}`} class="cursor-pointer">
                          <h3 class="text-xl font-bold text-gray-900">{account.name}</h3>
                          <p class="text-sm text-gray-600 mt-1">
                            {account.type} ¬∑ {account.currency}
                          </p>
                        </label>
                      </div>
                      <div class="text-right">
                        <p class="text-2xl font-bold text-gray-900">
                          {Number(account.current_value).toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                          <span class="text-sm text-gray-600 font-normal">{account.currency}</span>
                        </p>
                        {account.currency === 'USD' && (
                          <p class="text-xs text-gray-500 mt-1">
                            ‚âà {(Number(account.current_value) * currentRate).toLocaleString('es-CO', { minimumFractionDigits: 0 })} COP
                          </p>
                        )}
                        
                        {diff !== 0 && (
                          <div class={`text-xs font-semibold mt-2 ${diff > 0 ? 'text-green-600' : 'text-red-600'}`}>
                            {diff > 0 ? '‚Üë' : '‚Üì'} {Math.abs(diff).toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} {account.currency}
                            <span class="ml-1">({percentChange > 0 ? '+' : ''}{percentChange.toFixed(2)}%)</span>
                          </div>
                        )}
                      </div>
                    </div>
                    
                    <div class="">
                      <input type="hidden" name={`currency_${account.id}`} value={account.currency} />
                      <input type="hidden" name={`previous_value_${account.id}`} value={account.current_value} />
                      
                      <label class="block text-xs font-medium text-gray-700 mb-1">
                        Nuevo Valor ({account.currency})
                      </label>
                      <input
                        type="number"
                        name={`value_${account.id}`}
                        id={`value-${account.id}`}
                        step="0.01"
                        placeholder={Number(account.current_value).toString()}
                        class="w-full max-w-xs px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                      />
                    </div>
                    
                    <p class="text-xs text-gray-500 mt-2">
                      √öltima actualizaci√≥n: {new Date(account.last_update).toLocaleDateString('es-CO', { dateStyle: 'medium' })}
                    </p>
                  </div>
                </div>
              </div>

              <!-- Subcuentas -->
              {account.subaccounts.length > 0 && (
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4">
                  {account.subaccounts.map((sub: any) => {
                    const subDiff = calculateDifference(
                      Number(sub.current_value), 
                      Number(sub.previous_value)
                    );
                    
                    return (
                      <div class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition">
                        <div class="flex items-start gap-3 mb-3">
                          <input
                            type="checkbox"
                            name="selected_accounts"
                            value={sub.id}
                            id={`check-${sub.id}`}
                            class="account-checkbox mt-1 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                          />
                          
                          <div class="flex-1">
                            <div class="flex justify-between">
                              <label for={`check-${sub.id}`} class="cursor-pointer flex-1">
                                <h4 class="font-semibold text-gray-900 flex items-center gap-2">
                                  <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                  </svg>
                                  {sub.name}
                                </h4>
                                <p class="text-sm text-gray-600">{sub.type} ¬∑ {sub.currency}</p>
                              </label>
                              <div class="text-right">
                                <p class="text-lg font-bold text-gray-900">
                                  {Number(sub.current_value).toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                <span class="text-xs text-gray-600 font-normal">{sub.currency}</span>
                                </p>
                                
                                {sub.currency === 'USD' && (
                                  <p class="text-xs text-gray-500">
                                    ‚âà {(Number(sub.current_value) * currentRate).toLocaleString('es-CO', { minimumFractionDigits: 0 })} COP
                                  </p>
                                )}
                                
                                {subDiff.diff !== 0 && (
                                  <div class={`text-xs font-semibold mt-1 ${subDiff.diff > 0 ? 'text-green-600' : 'text-red-600'}`}>
                                    {subDiff.diff > 0 ? '‚Üë' : '‚Üì'} {Math.abs(subDiff.diff).toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} {sub.currency}
                                    <span class="ml-1">({subDiff.percentChange > 0 ? '+' : ''}{subDiff.percentChange.toFixed(2)}%)</span>
                                  </div>
                                )}
                              </div>
                            </div>
                            
                            <div class="mt-3">
                              <input type="hidden" name={`currency_${sub.id}`} value={sub.currency} />
                              <input type="hidden" name={`previous_value_${sub.id}`} value={sub.current_value} />
                              
                              <label class="block text-xs font-medium text-gray-700 mb-1">
                                Nuevo Valor ({sub.currency})
                              </label>
                              <input
                                type="number"
                                name={`value_${sub.id}`}
                                id={`value-${sub.id}`}
                                step="0.01"
                                placeholder={Number(sub.current_value).toString()}
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                              />
                            </div>
                            
                            <p class="text-xs text-gray-500 mt-2">
                              √öltima actualizaci√≥n: {new Date(sub.last_update).toLocaleDateString('es-CO', { dateStyle: 'medium' })}
                            </p>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          );
        })}
      </div>
    </form>

    <!-- Instrucciones -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
      <h3 class="font-semibold text-blue-900 mb-2">üí° Instrucciones</h3>
      <ul class="text-sm text-blue-800 space-y-1">
        <li>‚Ä¢ <strong>Selecciona las cuentas</strong> que deseas actualizar marcando los checkboxes</li>
        <li>‚Ä¢ Ingresa los nuevos valores para cada cuenta seleccionada</li>
        <li>‚Ä¢ La fecha se aplica a todas las cuentas que actualices</li>
        <li>‚Ä¢ Usa "Seleccionar todas" para marcar todas las cuentas de una vez</li>
        <li>‚Ä¢ Solo se actualizar√°n las cuentas seleccionadas que tengan un valor ingresado</li>
        <li>‚Ä¢ Las flechas ‚Üë‚Üì muestran el cambio desde la √∫ltima actualizaci√≥n</li>
      </ul>
    </div>
  </div>

  <script>
    // Funcionalidad de seleccionar todas
    const selectAllBtn = document.getElementById('select-all-btn');
    const checkboxes = document.querySelectorAll('.account-checkbox');
    let allSelected = false;

    selectAllBtn?.addEventListener('click', () => {
      allSelected = !allSelected;
      checkboxes.forEach(checkbox => {
        (checkbox as HTMLInputElement).checked = allSelected;
      });
      selectAllBtn.textContent = allSelected ? 'Deseleccionar todas' : 'Seleccionar todas';
    });

    // Auto-seleccionar checkbox cuando se ingresa un valor
    document.querySelectorAll('input[name^="value_"]').forEach(input => {
      input.addEventListener('input', (e) => {
        const target = e.target as HTMLInputElement;
        const accountId = target.name.replace('value_', '');
        const checkbox = document.getElementById(`check-${accountId}`) as HTMLInputElement;
        if (checkbox && target.value) {
          checkbox.checked = true;
        }
      });
    });
  </script>
</Default>