---
import Layout from "@layouts/default.astro";
import { asRows, sql } from "@lib/db";
import { getCategories } from "@lib/categories";
import CsrfField from "@components/CsrfField.astro";

const {userId, name, userRole} = Astro.locals;

if (!userId) {
  return Astro.redirect("/auth/login?returnTo=/dashboard/withdraw");
}

// Obtener cuentas disponibles
const accounts = asRows<{
  id: number;
  name: string;
  balance: number;
  currency: string;
}>(
  await sql`
    SELECT 
      a.id,
      a.name,
      a.currency,
      COALESCE(pv.new_value, 0) as balance
    FROM accounts a
    LEFT JOIN LATERAL (
      SELECT new_value
      FROM transactions
      WHERE account_id = a.id
      AND user_id = ${userId}
      ORDER BY updated_at DESC
      LIMIT 1
    ) pv ON true
    WHERE a.currency IN ('COP', 'USD')
    AND a.user_id = ${userId}
    ORDER BY a.name ASC;
  `,
);

// Obtener categorías de tipo 'expense' (retiros)
const categories = await getCategories("expense");

const url = new URL(Astro.request.url);
const withdrawSuccess = url.searchParams.get("withdraw_success");
const errorMessage = url.searchParams.get("error");
const today = new Date().toLocaleDateString("en-CA", {
  timeZone: "America/Bogota",
});
---

<Layout title="Retirar Fondos" activePage="withdraw" name={name} user_type={userRole}>
  <div class="max-w-2xl mx-auto space-y-6">
    <!-- Header -->
    <div class="mb-8 pl-1">
      <h1 class="text-3xl font-bold text-gray-900 tracking-tight">
        Retirar Fondos
      </h1>
      <p class="mt-2 text-gray-500">
        Registra una salida de capital de tu portafolio
      </p>
    </div>

    <!-- Mensajes de éxito/error -->
    {
      withdrawSuccess === "1" && (
        <div class="mb-6 bg-emerald-50 border border-emerald-100 rounded-xl p-4 animate-zen-fade-up">
          <div class="flex items-center">
            <div class="flex-shrink-0 bg-emerald-100 rounded-full p-1.5">
              <svg
                class="h-5 w-5 text-emerald-600"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fill-rule="evenodd"
                  d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                  clip-rule="evenodd"
                />
              </svg>
            </div>
            <div class="ml-3">
              <p class="text-sm font-semibold text-emerald-800">
                ¡Retiro registrado exitosamente!
              </p>
            </div>
          </div>
        </div>
      )
    }
    {
      withdrawSuccess === "0" && (
        <div class="mb-6 bg-red-50 border border-red-100 rounded-xl p-4 animate-zen-fade-up">
          <div class="flex items-center">
            <div class="flex-shrink-0 bg-red-100 rounded-full p-1.5">
              <svg
                class="h-5 w-5 text-red-600"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fill-rule="evenodd"
                  d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                  clip-rule="evenodd"
                />
              </svg>
            </div>
            <div class="ml-3">
              <p class="text-sm font-medium text-red-800">
                Error al realizar el retiro
              </p>
              {errorMessage && (
                <p class="text-xs text-red-600 mt-1">
                  {decodeURIComponent(errorMessage)}
                </p>
              )}
            </div>
          </div>
        </div>
      )
    }

    <!-- Formulario de retiro moderno -->
    <div
      class="bg-white shadow-sm rounded-2xl border border-gray-100 overflow-hidden animate-zen-fade-up stagger-1"
    >
      <form
        method="POST"
        action="/api/transactions/withdraw"
        class="p-6 md:p-8 space-y-8"
      >
        <CsrfField />

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <!-- Cuenta -->
          <div class="col-span-1 md:col-span-2">
            <label
              for="account_id"
              class="block text-sm font-medium text-gray-700 mb-2"
              >Cuenta de Origen</label
            >
            <div class="relative">
              <select
                id="account_id"
                name="account_id"
                required
                class="appearance-none w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500/20 focus:border-red-500 transition text-gray-900 font-medium cursor-pointer hover:bg-white"
                onchange="updateCurrencySymbol(this)"
              >
                <option value="" data-currency=""
                  >Selecciona una cuenta...</option
                >
                {
                  accounts.map((account) => (
                    <option
                      value={account.id}
                      data-currency={account.currency}
                      data-balance={account.balance}
                    >
                      {account.name} · {account.currency} · Disponible: $
                      {account.balance.toLocaleString()}
                    </option>
                  ))
                }
              </select>
              <div
                class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500"
              >
                <svg
                  class="h-4 w-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 9l-7 7-7-7"></path></svg
                >
              </div>
            </div>
          </div>

          <!-- Categoría -->
          <div class="col-span-1 md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-3"
              >Motivo del Retiro</label
            >
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
              {
                categories.map((cat) => (
                  <label class="cursor-pointer group">
                    <input
                      type="radio"
                      name="category_id"
                      value={cat.id}
                      class="peer sr-only"
                      required
                    />
                    <div class="flex flex-col items-center justify-center p-4 rounded-2xl border border-gray-200 bg-white hover:bg-gray-50 peer-checked:border-red-500 peer-checked:bg-red-50/20 peer-checked:text-red-700 transition-all h-full">
                      <span class="text-2xl mb-2 group-hover:scale-110 transition-transform">
                        {cat.icon}
                      </span>
                      <span class="text-xs font-semibold text-center">
                        {cat.name}
                      </span>
                    </div>
                  </label>
                ))
              }
            </div>
          </div>

          <!-- Monto -->
          <div>
            <label
              for="amount"
              class="block text-sm font-medium text-gray-700 mb-2"
              >Monto a Retirar</label
            >
            <div class="relative group">
              <span
                id="currency-symbol"
                class="absolute left-4 top-3.5 text-gray-400 font-medium transition-colors group-focus-within:text-red-500"
                >$</span
              >
              <input
                type="number"
                id="amount"
                name="amount"
                step="0.01"
                min="0.01"
                placeholder="0.00"
                required
                class="w-full pl-8 pr-4 py-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500/20 focus:border-red-500 transition text-lg font-bold text-gray-900 placeholder:text-gray-300"
              />
            </div>
          </div>

          <!-- Fecha -->
          <div>
            <label
              for="date"
              class="block text-sm font-medium text-gray-700 mb-2">Fecha</label
            >
            <input
              type="date"
              id="date"
              name="date"
              value={today}
              required
              class="w-full px-4 py-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500/20 focus:border-red-500 transition text-gray-900 font-medium appearance-none"
            />
          </div>

          <!-- Nota -->
          <div class="col-span-1 md:col-span-2">
            <label
              for="note"
              class="block text-sm font-medium text-gray-700 mb-2"
              >Nota Adicional</label
            >
            <textarea
              id="note"
              name="note"
              rows="2"
              placeholder="Detalles opcionales..."
              class="w-full px-4 py-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500/20 focus:border-red-500 transition text-gray-900 font-medium resize-none placeholder:text-gray-300"
            ></textarea>
          </div>
        </div>

        <!-- Botones -->
        <div class="flex items-center gap-4 pt-4 border-t border-gray-50">
          <a
            href="/dashboard"
            class="flex-1 text-center text-gray-500 px-6 py-3 rounded-xl font-medium hover:bg-gray-50 hover:text-gray-900 transition"
          >
            Cancelar
          </a>
          <button
            type="submit"
            class="flex-[2] bg-red-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-red-600/20 hover:bg-red-700 hover:shadow-red-600/30 transition-all transform hover:-translate-y-0.5 active:translate-y-0"
          >
            Confirmar Retiro
          </button>
        </div>
      </form>
    </div>
  </div>
</Layout>

<script is:inline>
  function updateCurrencySymbol(select) {
    const selectedOption = select.options[select.selectedIndex];
    const currency = selectedOption.getAttribute("data-currency");
    const symbolSpan = document.getElementById("currency-symbol");
    if (symbolSpan) {
      // Podríamos poner símbolos específicos si quisiéramos (USD: $, EUR: €)
      // Por ahora mantenemos $, pero la lógica está lista.
    }
  }

  // Validación de saldo en cliente de forma más elegante
  const form = document.querySelector("form");
  const amountInput = document.getElementById("amount");
  const accountSelect = document.getElementById("account_id");

  form?.addEventListener("submit", (e) => {
    const amount = parseFloat(amountInput.value);
    const selectedOption = accountSelect.options[accountSelect.selectedIndex];
    const balance = parseFloat(selectedOption.getAttribute("data-balance"));

    if (!isNaN(balance) && amount > balance) {
      e.preventDefault();
      // Usar un toast o un div de error en lugar de alert sería más Zen, pero alert funciona por ahora.
      alert(
        `⚠️ Saldo insuficiente.\n\nSolo tienes disponibles $${balance.toLocaleString()} en esta cuenta.`,
      );
    }
  });
</script>
