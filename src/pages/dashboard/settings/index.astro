---
import Layout from "@layouts/default.astro";
import { sql } from "@lib/db";
import { handleApiError } from "@lib/error-handler";

const {userId, name, userRole} = Astro.locals;
if (!userId) return Astro.redirect("/auth/login");

// Obtener datos del usuario
const userResult = await sql`SELECT * FROM users WHERE id = ${userId}`;
if (userResult.length === 0) return Astro.redirect("/auth/logout");
const user = userResult[0];

// Mensajes de éxito/error
const success = Astro.url.searchParams.get("success");
const error = Astro.url.searchParams.get("error");
---

<Layout title="Ajustes de Cuenta" activePage="settings" name={name} user_type={userRole}>
    <div class="max-w-4xl mx-auto space-y-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Ajustes</h1>
                <p class="text-gray-600 mt-1">
                    Administra tu perfil y preferencias
                </p>
            </div>
        </div>

        <!-- Feedback Messages -->
        {
            success && (
                <div class="bg-green-100 border border-green-200 text-green-700 px-4 py-3 rounded-lg flex items-center gap-2">
                    <svg
                        class="w-5 h-5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M5 13l4 4L19 7"
                        />
                    </svg>
                    {success === "profile_updated" &&
                        "Perfil actualizado correctamente."}
                    {success === "password_updated" &&
                        "Contraseña actualizada correctamente."}
                </div>
            )
        }
        {
            error && (
                <div class="bg-red-100 border border-red-200 text-red-700 px-4 py-3 rounded-lg flex items-center gap-2">
                    <svg
                        class="w-5 h-5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                        />
                    </svg>
                    {error}
                </div>
            )
        }

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Sidebar de Ajustes (Tabs visuales si hiciéramos SPA, aquí vertical layout) -->
            <div class="md:col-span-1 space-y-2">
                <a
                    href="#profile"
                    class="block w-full text-left px-4 py-3 rounded-lg bg-white border border-gray-200 shadow-sm font-medium text-gray-900 hover:bg-gray-50"
                >
                    Perfil
                </a>
                <a
                    href="#security"
                    class="block w-full text-left px-4 py-3 rounded-lg bg-white border border-gray-200 shadow-sm font-medium text-gray-900 hover:bg-gray-50"
                >
                    Seguridad
                </a>
                <a
                    href="#preferences"
                    class="block w-full text-left px-4 py-3 rounded-lg bg-white border border-gray-200 shadow-sm font-medium text-gray-900 hover:bg-gray-50"
                >
                    Preferencias
                </a>
            </div>

            <!-- Contenido -->
            <div class="md:col-span-2 space-y-8">
                <!-- Perfil -->
                <section
                    id="profile"
                    class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 scroll-mt-24"
                >
                    <h2
                        class="text-xl font-bold text-gray-900 mb-4 border-b pb-2"
                    >
                        Información de Perfil
                    </h2>
                    <form
                        action="/api/settings/profile"
                        method="POST"
                        class="space-y-4"
                    >
                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700 mb-1"
                                >Nombre Completo</label
                            >
                            <input
                                type="text"
                                name="name"
                                value={user.name || ""}
                                class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                            />
                        </div>
                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700 mb-1"
                                >Correo Electrónico</label
                            >
                            <input
                                type="email"
                                value={user.email}
                                disabled
                                class="w-full rounded-lg border-gray-300 bg-gray-100 text-gray-500 cursor-not-allowed"
                            />
                            <p class="text-xs text-gray-500 mt-1">
                                El correo no se puede cambiar directamente.
                            </p>
                        </div>
                        <div class="flex justify-end pt-2">
                            <button
                                type="submit"
                                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition font-medium"
                            >
                                Guardar Cambios
                            </button>
                        </div>
                    </form>
                </section>

                <!-- Seguridad -->
                <section
                    id="security"
                    class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 scroll-mt-24"
                >
                    <h2
                        class="text-xl font-bold text-gray-900 mb-4 border-b pb-2"
                    >
                        Seguridad
                    </h2>
                    <form
                        action="/api/settings/password"
                        method="POST"
                        class="space-y-4"
                    >
                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700 mb-1"
                                >Contraseña Actual</label
                            >
                            <input
                                type="password"
                                name="current_password"
                                required
                                class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                            />
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label
                                    class="block text-sm font-medium text-gray-700 mb-1"
                                    >Nueva Contraseña</label
                                >
                                <input
                                    type="password"
                                    name="new_password"
                                    required
                                    minlength="8"
                                    class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                />
                            </div>
                            <div>
                                <label
                                    class="block text-sm font-medium text-gray-700 mb-1"
                                    >Confirmar Nueva</label
                                >
                                <input
                                    type="password"
                                    name="confirm_password"
                                    required
                                    minlength="8"
                                    class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                />
                            </div>
                        </div>
                        <div class="flex justify-end pt-2">
                            <button
                                type="submit"
                                class="bg-gray-800 text-white px-4 py-2 rounded-lg hover:bg-gray-900 transition font-medium"
                            >
                                Actualizar Contraseña
                            </button>
                        </div>
                    </form>

                    <div class="mt-8 pt-6 border-t border-gray-100">
                        <h3 class="text-md font-bold text-gray-900 mb-2">
                            Autenticación de Dos Factores (2FA)
                        </h3>
                        <p class="text-sm text-gray-500 mb-4">
                            Añade una capa extra de seguridad a tu cuenta.
                        </p>
                        <button
                            disabled
                            class="bg-gray-100 text-gray-400 px-4 py-2 rounded-lg cursor-not-allowed border border-gray-200"
                        >
                            Próximamente
                        </button>
                    </div>
                </section>

                <!-- Preferencias -->
                <section
                    id="preferences"
                    class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 scroll-mt-24"
                >
                    <h2
                        class="text-xl font-bold text-gray-900 mb-4 border-b pb-2"
                    >
                        Preferencias
                    </h2>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-medium text-gray-900">
                                    Tema Oscuro
                                </p>
                                <p class="text-sm text-gray-500">
                                    Cambiar la apariencia de la aplicación
                                </p>
                            </div>
                            <!-- Toggle visual (funcionalidad JS pendiente en global) -->
                            <button
                                class="bg-gray-200 relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                                role="switch"
                                aria-checked="false"
                            >
                                <span
                                    aria-hidden="true"
                                    class="translate-x-0 pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"
                                ></span>
                            </button>
                        </div>
                        <div
                            class="flex items-center justify-between pt-4 border-t border-gray-50"
                        >
                            <div>
                                <p class="font-medium text-gray-900">
                                    Moneda por Defecto
                                </p>
                                <p class="text-sm text-gray-500">
                                    Moneda principal para los reportes
                                </p>
                            </div>
                            <select
                                disabled
                                class="rounded-lg border-gray-300 bg-gray-50 text-gray-500 cursor-not-allowed text-sm"
                            >
                                <option>COP (Peso Colombiano)</option>
                                <option>USD (Dólar Estadounidense)</option>
                            </select>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>
</Layout>
