---
import Layout from "@layouts/home.astro";

const token = Astro.url.searchParams.get("token");
const error = Astro.url.searchParams.get("error");

if (!token) {
    return Astro.redirect(
        "/auth/login?error=" +
            encodeURIComponent("Token de verificación inválido"),
    );
}
---

<Layout title="Verificar Correo">
    <div
        class="min-h-screen flex items-center justify-center px-4 sm:px-6 lg:px-8 py-8 sm:py-12"
    >
        <div
            class="w-full max-w-md bg-stone-900/60 backdrop-blur-xl border border-stone-800
             shadow-2xl rounded-3xl p-6 sm:p-8 animate-fadeIn text-center"
        >
            <div class="flex justify-center mb-6">
                <img
                    src="/logo.png"
                    alt="Capyte"
                    class="w-16 h-16 rounded-2xl shadow-lg shadow-amber-900/20"
                />
            </div>

            {
                !error ? (
                    <div>
                        <div class="w-16 h-16 bg-amber-500/10 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg
                                class="w-8 h-8 text-amber-500"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M5 13l4 4L19 7"
                                />
                            </svg>
                        </div>
                        <h1 class="text-2xl sm:text-3xl font-bold text-stone-100 mb-2">
                            Verificando...
                        </h1>
                        <p class="text-sm sm:text-base text-stone-400 mb-6">
                            Estamos verificando tu correo electrónico
                        </p>
                        <div class="flex justify-center">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-amber-500" />
                        </div>
                    </div>
                ) : (
                    <div>
                        <div class="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg
                                class="w-8 h-8 text-red-400"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"
                                />
                            </svg>
                        </div>
                        <h1 class="text-2xl sm:text-3xl font-bold text-stone-100 mb-2">
                            Error
                        </h1>
                        <p class="text-sm sm:text-base text-red-300 mb-6">
                            {decodeURIComponent(error)}
                        </p>
                        <a
                            href="/auth/login"
                            class="inline-block px-6 py-3 rounded-xl bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-500 hover:to-orange-500 transition-all text-white font-bold shadow-lg"
                        >
                            Ir al inicio de sesión
                        </a>
                    </div>
                )
            }
        </div>
    </div>

    <script define:vars={{ token }}>
        // Auto-verificar al cargar la página
        if (token && !window.location.search.includes("error")) {
            fetch(`/api/auth/verify-email?token=${encodeURIComponent(token)}`)
                .then((res) => {
                    if (res.redirected) {
                        window.location.href = res.url;
                    }
                })
                .catch((err) => {
                    console.error(err);
                    window.location.href = `/auth/verify-email?token=${token}&error=${encodeURIComponent("Error al verificar")}`;
                });
        }
    </script>

    <style>
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fadeIn {
            animation: fadeIn 0.7s ease-out forwards;
        }
    </style>
</Layout>
