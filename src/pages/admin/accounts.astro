---
import Layout from "@layouts/default.astro";
import { sql } from "@lib/db";

const userId = Astro.locals.userId;

if (!userId) {
  return Astro.redirect("/auth/login?returnTo=/dashboard/accounts");
}

// Obtener tasa de cambio USD
const usdRateResult = await sql`
  SELECT usd_to_cop 
  FROM exchange_rates 
  ORDER BY date DESC 
  LIMIT 1
`;
const usdRate = Number(usdRateResult[0]?.usd_to_cop || 3900);

let message: { type: "success" | "error"; text: string } | null = null;

// Manejar POST para crear cuenta o subcuenta
if (Astro.request.method === "POST") {
  try {
    const formData = await Astro.request.formData();
    const action = formData.get("action");

    // Si es una acción de eliminar
    if (action === "delete") {
      const accountId = formData.get("account_id");

      if (!accountId) {
        throw new Error("ID de cuenta no proporcionado.");
      }

      // Verificar si tiene subcuentas
      const subaccounts = await sql`
        SELECT COUNT(*) as count 
        FROM accounts 
        WHERE parent_account_id = ${accountId} 
          AND user_id = ${userId};
      `;

      if (Number(subaccounts[0].count) > 0) {
        throw new Error(
          "No puedes eliminar una cuenta con subcuentas activas.",
        );
      }

      // Verificar si tiene transacciones
      const transactions = await sql`
        SELECT COUNT(*) as count 
        FROM transactions 
        WHERE account_id = ${accountId};
      `;

      if (Number(transactions[0].count) > 0) {
        throw new Error(
          "No puedes eliminar una cuenta con transacciones. Considera desactivarla en su lugar.",
        );
      }

      await sql`DELETE FROM accounts WHERE id = ${accountId};`;
      return Astro.redirect("/admin/accounts?success=2");
    }

    // Si no, es crear cuenta/subcuenta
    const name = formData.get("name");
    const type = formData.get("type");
    const currency = formData.get("currency");
    const parentAccountId = formData.get("parent_account_id");

    if (!name || !type || !currency) {
      throw new Error("Todos los campos son obligatorios.");
    }

    if (parentAccountId && parentAccountId !== "") {
      // Crear subcuenta
      await sql`
        INSERT INTO accounts (name, type, currency, parent_account_id, user_id)
        VALUES (${name}, ${type}, ${currency}, ${parentAccountId}, ${userId});
      `;
    } else {
      // Crear cuenta principal
      await sql`
        INSERT INTO accounts (name, type, currency, user_id)
        VALUES (${name}, ${type}, ${currency}, ${userId});
      `;
    }

    return Astro.redirect("/admin/accounts?success=1");
  } catch (e) {
    console.error("Error al procesar la solicitud:", e);
    const errorMsg = e instanceof Error ? e.message : "Error desconocido";
    return Astro.redirect(
      `/admin/accounts?error=${encodeURIComponent(errorMsg)}`,
    );
  }
}

// Mensajes de URL
const urlSuccess = Astro.url.searchParams.get("success");
const urlError = Astro.url.searchParams.get("error");

if (urlSuccess === "1") {
  message = { type: "success", text: "Cuenta creada correctamente." };
} else if (urlSuccess === "2") {
  message = { type: "success", text: "Cuenta eliminada correctamente." };
} else if (urlError) {
  message = { type: "error", text: decodeURIComponent(urlError) };
}

// ✅ CORREGIDO: Consulta directa a transactions para obtener balances reales
const accountsRaw = await sql`
  SELECT
    a.id,
    a.name,
    a.type,
    a.currency,
    a.parent_account_id,
    
    -- ✅ Balance real: último new_value de transactions
    COALESCE(
      (
        SELECT t.new_value
        FROM transactions t
        WHERE t.account_id = a.id
        ORDER BY t.date DESC, t.created_at DESC, t.id DESC
        LIMIT 1
      ),
      0
    ) AS latest_value,
    
    -- Última tasa USD->COP usada (para conversiones históricas)
    (
      SELECT t.usd_to_cop_rate
      FROM transactions t
      WHERE t.account_id = a.id 
        AND t.usd_to_cop_rate IS NOT NULL
      ORDER BY t.date DESC, t.created_at DESC, t.id DESC
      LIMIT 1
    ) AS historical_usd_rate,
    
    -- Fecha de última actualización
    (
      SELECT t.date
      FROM transactions t
      WHERE t.account_id = a.id
      ORDER BY t.date DESC, t.created_at DESC, t.id DESC
      LIMIT 1
    ) AS last_update

  FROM accounts a
  WHERE a.user_id = ${userId}
  
  ORDER BY 
    COALESCE(a.parent_account_id, a.id) ASC,
    CASE WHEN a.parent_account_id IS NULL THEN 0 ELSE 1 END ASC,
    a.name ASC;
`;

// ✅ Procesar cuentas: calcular valores en moneda original y COP
interface Account {
  id: number;
  name: string;
  type: string;
  currency: string;
  parent_account_id: number | null;
  latest_value: number;
  latest_value_cop: number;
  subaccounts: Account[];
  subaccounts_count: number;
  total_with_subs: number;
  total_with_subs_cop: number;
  last_update: string | null;
}

const accountsMap = new Map<number, Account>();

// Primera pasada: crear objetos de cuenta
accountsRaw.forEach((acc: any) => {
  const value = Number(acc.latest_value || 0);

  // Para conversión a COP: usar tasa histórica si existe, sino usar tasa actual
  const rateToUse =
    acc.currency === "USD"
      ? acc.historical_usd_rate
        ? Number(acc.historical_usd_rate)
        : usdRate
      : 1;

  const valueCOP = acc.currency === "USD" ? value * rateToUse : value;

  accountsMap.set(acc.id, {
    id: acc.id,
    name: acc.name,
    type: acc.type,
    currency: acc.currency,
    parent_account_id: acc.parent_account_id,
    latest_value: value,
    latest_value_cop: valueCOP,
    subaccounts: [],
    subaccounts_count: 0,
    total_with_subs: value,
    total_with_subs_cop: valueCOP,
    last_update: acc.last_update,
  });
});

// Segunda pasada: organizar jerarquía y calcular totales
accountsMap.forEach((account) => {
  if (account.parent_account_id) {
    const parent = accountsMap.get(account.parent_account_id);
    if (parent) {
      parent.subaccounts.push(account);
      parent.subaccounts_count++;

      // ✅ REGLA: El total de la cuenta padre = su propio balance + suma de subcuentas
      // (Si la cuenta padre no debería tener balance propio, ajusta esta lógica)
      parent.total_with_subs += account.latest_value;
      parent.total_with_subs_cop += account.latest_value_cop;
    }
  }
});

// Filtrar solo cuentas principales para el template
const mainAccounts = Array.from(accountsMap.values()).filter(
  (acc) => acc.parent_account_id === null,
);

// Convertir a array para el template
const accounts = Array.from(accountsMap.values());
---

<Layout title="Gestión de Cuentas" activePage="accounts">
  <div class="max-w-7xl mx-auto space-y-4 sm:space-y-6">
    <div
      class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"
    >
      <div>
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">
          Gestión de Cuentas
        </h1>
        <p class="text-sm sm:text-base text-gray-600 mt-1">
          Administra tus cuentas de inversión y subcuentas
        </p>
      </div>
      <button
        onclick="document.getElementById('createModal').classList.remove('hidden')"
        class="w-full sm:w-auto px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium whitespace-nowrap"
      >
        + Nueva Cuenta
      </button>
    </div>

    {
      message && (
        <div
          class={`p-4 rounded-lg border ${message.type === "success" ? "bg-green-50 border-green-200" : "bg-red-50 border-red-200"}`}
        >
          <p
            class={`text-sm font-medium ${message.type === "success" ? "text-green-800" : "text-red-800"}`}
          >
            {message.text}
          </p>
        </div>
      )
    }

    <!-- Lista de Cuentas -->
    <div
      class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 sm:p-6"
    >
      <h3 class="text-lg font-semibold text-gray-900 mb-4">
        Todas las Cuentas
      </h3>
      <div class="space-y-4">
        {
          mainAccounts.map((acc) => {
            return (
              <div class="border border-gray-200 rounded-lg p-3 sm:p-4">
                {/* Cuenta Principal */}
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                  <div class="flex items-center gap-3 sm:gap-4">
                    <div class="p-2 sm:p-3 bg-blue-100 rounded-lg flex-shrink-0">
                      <svg
                        class="w-4 h-4 sm:w-5 sm:h-5 text-blue-600"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
                        />
                      </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                      <p class="font-bold text-gray-900 text-sm sm:text-base truncate">
                        {acc.name}
                      </p>
                      <p class="text-xs sm:text-sm text-gray-500">
                        {acc.type} · {acc.currency}
                        {acc.subaccounts_count > 0 &&
                          ` · ${acc.subaccounts_count} subcuentas`}
                      </p>
                    </div>
                  </div>
                  <div class="flex items-center justify-between sm:justify-end gap-2 sm:gap-4">
                    <div class="text-left sm:text-right">
                      <p class="font-bold text-gray-900 text-sm sm:text-base">
                        {acc.total_with_subs.toLocaleString("en-US", {
                          minimumFractionDigits: 2,
                          maximumFractionDigits: 2,
                        })}{" "}
                        {acc.currency}
                      </p>
                      <p class="text-xs text-gray-500">
                        {acc.currency === "USD"
                          ? `${acc.total_with_subs_cop.toLocaleString("es-CO", {
                              minimumFractionDigits: 0,
                              maximumFractionDigits: 0,
                            })} COP`
                          : ""}
                      </p>
                    </div>
                    <div class="flex gap-2">
                      <button
                        onclick={`openSubaccountModal(${acc.id}, '${acc.name}')`}
                        class="px-2 sm:px-3 py-1 text-xs sm:text-sm bg-green-100 text-green-700 rounded hover:bg-green-200 transition whitespace-nowrap"
                        title="Crear subcuenta"
                      >
                        <svg
                          class="w-4 h-4 sm:w-5 sm:h-5 inline pointer-events-none"
                          viewBox="0 0 24 24"
                          fill="none"
                          xmlns="http://www.w3.org/2000/svg"
                        >
                          <path
                            d="M3 9V19.4C3 19.9601 3 20.2399 3.10899 20.4538C3.20487 20.642 3.35774 20.7952 3.5459 20.8911C3.7596 21 4.0395 21 4.59846 21H15.0001M14 13V10M14 10V7M14 10H11M14 10H17M7 13.8002V6.2002C7 5.08009 7 4.51962 7.21799 4.0918C7.40973 3.71547 7.71547 3.40973 8.0918 3.21799C8.51962 3 9.08009 3 10.2002 3H17.8002C18.9203 3 19.4801 3 19.9079 3.21799C20.2842 3.40973 20.5905 3.71547 20.7822 4.0918C21.0002 4.51962 21.0002 5.07969 21.0002 6.19978L21.0002 13.7998C21.0002 14.9199 21.0002 15.48 20.7822 15.9078C20.5905 16.2841 20.2842 16.5905 19.9079 16.7822C19.4805 17 18.9215 17 17.8036 17H10.1969C9.07899 17 8.5192 17 8.0918 16.7822C7.71547 16.5905 7.40973 16.2842 7.21799 15.9079C7 15.4801 7 14.9203 7 13.8002Z"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                          />
                        </svg>
                      </button>
                      <button
                        onclick={`confirmDelete(${acc.id}, '${acc.name}', ${acc.subaccounts_count})`}
                        class="px-2 sm:px-3 py-1 text-xs sm:text-sm bg-red-100 text-red-700 rounded hover:bg-red-200 transition"
                        title="Eliminar cuenta"
                      >
                        <svg
                          class="w-4 h-4 sm:w-5 sm:h-5 inline pointer-events-none"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                          />
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>

                {/* Subcuentas */}
                {acc.subaccounts.length > 0 && (
                  <div class="ml-4 sm:ml-12 mt-3 sm:mt-4 space-y-2">
                    {acc.subaccounts.map((sub) => (
                      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 sm:gap-4 p-2 sm:p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center gap-2 sm:gap-3 min-w-0">
                          <svg
                            class="w-3 h-3 sm:w-4 sm:h-4 text-gray-500 flex-shrink-0"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                            />
                          </svg>
                          <div class="flex-1 min-w-0">
                            <p class="font-semibold text-gray-900 text-xs sm:text-sm truncate">
                              {sub.name}
                            </p>
                            <p class="text-xs text-gray-500">{sub.type}</p>
                          </div>
                        </div>
                        <div class="flex items-center justify-between sm:justify-end gap-2 sm:gap-4">
                          <div class="text-left sm:text-right">
                            <p class="font-semibold text-gray-900 text-xs sm:text-sm">
                              {sub.latest_value.toLocaleString("en-US", {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2,
                              })}{" "}
                              {sub.currency}
                            </p>
                            <p class="text-xs text-gray-500">
                              {sub.currency === "USD"
                                ? `${sub.latest_value_cop.toLocaleString(
                                    "es-CO",
                                    {
                                      minimumFractionDigits: 0,
                                      maximumFractionDigits: 0,
                                    },
                                  )} COP`
                                : ""}
                            </p>
                          </div>
                          <button
                            onclick={`confirmDelete(${sub.id}, '${sub.name}', 0)`}
                            class="px-2 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200 transition flex-shrink-0"
                            title="Eliminar subcuenta"
                          >
                            <svg
                              class="w-4 h-4 sm:w-5 sm:h-5 inline pointer-events-none"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                              />
                            </svg>
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            );
          })
        }
      </div>
    </div>
  </div>

  <!-- Modal: Crear Cuenta Principal -->
  <div
    id="createModal"
    class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  >
    <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
      <h3 class="text-xl font-bold text-gray-900 mb-4">Crear Nueva Cuenta</h3>
      <form method="POST" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Nombre de la Cuenta</label
          >
          <input
            type="text"
            name="name"
            required
            class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500"
            placeholder="Ej: Interactive Brokers"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Tipo</label
          >
          <select
            name="type"
            required
            class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500"
          >
            <option value="broker">Broker</option>
            <option value="fondo">Fondo de Inversión</option>
            <option value="banco">Cuenta Bancaria</option>
            <option value="cripto">Crypto Exchange</option>
            <option value="otro">Otro</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Moneda</label
          >
          <select
            name="currency"
            required
            class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500"
          >
            <option value="COP">COP</option>
            <option value="USD">USD</option>
          </select>
        </div>
        <div class="flex flex-col sm:flex-row gap-3">
          <button
            type="button"
            onclick="closeCreateModal()"
            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition text-sm sm:text-base"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm sm:text-base"
          >
            Crear Cuenta
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Crear Subcuenta -->
  <div
    id="subaccountModal"
    class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  >
    <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
      <h3 class="text-xl font-bold text-gray-900 mb-4">Crear Subcuenta</h3>
      <p class="text-sm text-gray-600 mb-4">
        Cuenta padre: <span id="parentAccountName" class="font-semibold"></span>
      </p>
      <form method="POST" class="space-y-4">
        <input
          type="hidden"
          name="parent_account_id"
          id="parentAccountIdInput"
        />
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Nombre de la Subcuenta</label
          >
          <input
            type="text"
            name="name"
            required
            class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500"
            placeholder="Ej: Acciones Tech"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Tipo</label
          >
          <select
            name="type"
            required
            class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500"
          >
            <option value="Acciones">Acciones</option>
            <option value="Criptomoneda">Criptomoneda</option>
            <option value="Fondo de Inversión">Fondo de Inversión</option>
            <option value="Renta Fija">Renta Fija</option>
            <option value="Renta Variable">Renta Variable</option>
            <option value="Liquidez">Liquidez</option>
            <option value="Crecimiento">Crecimiento</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Moneda</label
          >
          <select
            name="currency"
            required
            class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500"
          >
            <option value="COP">COP</option>
            <option value="USD">USD</option>
          </select>
        </div>
        <div class="flex flex-col sm:flex-row gap-3">
          <button
            type="button"
            onclick="closeSubaccountModal()"
            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition text-sm sm:text-base"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm sm:text-base"
          >
            Crear Subcuenta
          </button>
        </div>
      </form>
    </div>
  </div>

  <script is:inline>
    function openSubaccountModal(parentId, parentName) {
      document.getElementById("parentAccountIdInput").value =
        parentId.toString();
      document.getElementById("parentAccountName").textContent = parentName;
      document.getElementById("subaccountModal").classList.remove("hidden");
    }

    function closeCreateModal() {
      document.getElementById("createModal").classList.add("hidden");
    }

    function closeSubaccountModal() {
      document.getElementById("subaccountModal").classList.add("hidden");
    }

    function confirmDelete(accountId, accountName, subaccountsCount) {
      if (subaccountsCount > 0) {
        alert(
          'No puedes eliminar "' +
            accountName +
            '" porque tiene ' +
            subaccountsCount +
            " subcuentas activas.",
        );
        return;
      }

      if (
        confirm(
          '¿Estás seguro de eliminar la cuenta "' +
            accountName +
            '"? Esta acción no se puede deshacer.',
        )
      ) {
        const form = document.createElement("form");
        form.method = "POST";
        form.action = window.location.href;

        const actionInput = document.createElement("input");
        actionInput.type = "hidden";
        actionInput.name = "action";
        actionInput.value = "delete";
        form.appendChild(actionInput);

        const input = document.createElement("input");
        input.type = "hidden";
        input.name = "account_id";
        input.value = accountId;
        form.appendChild(input);

        document.body.appendChild(form);
        form.submit();
      }
    }
  </script>
</Layout>
