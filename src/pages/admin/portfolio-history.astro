---
import Layout from "@layouts/default.astro";
import AccountChart from "@components/graphics/AccountChart.astro";
import Sidebar from "@components/sidebar.astro";
import { sql } from "@lib/db";

// Fetch all accounts with parent relationship
const allAccounts = await sql`
  SELECT id, name, currency, parent_account_id 
  FROM accounts 
  ORDER BY parent_account_id NULLS FIRST, id;
`;

// Organize accounts into hierarchy
const accountsWithHistory = await Promise.all(
  allAccounts
    .filter(acc => !acc.parent_account_id) // Only process parent accounts
    .map(async (account) => {
      // Get subaccounts
      const subaccounts = allAccounts.filter(
        sub => sub.parent_account_id === account.id
      );

      // Fetch history for main account
      const mainHistory = await sql`
        SELECT date, value
        FROM account_value_history
        WHERE account_id = ${account.id}
        ORDER BY date ASC;
      `;

      let finalHistory = mainHistory.map((h) => ({
        date: h.date,
        value: parseFloat(h.value),
      }));

      // If main account has no values or all zeros, aggregate subaccounts
      const hasMainValue = finalHistory.some(h => h.value > 0);
      
      if (!hasMainValue && subaccounts.length > 0) {
        // Fetch all subaccount histories
        const subHistories = await Promise.all(
          subaccounts.map(async (sub) => {
            const subHistory = await sql`
              SELECT date, value
              FROM account_value_history
              WHERE account_id = ${sub.id}
              ORDER BY date ASC;
            `;
            return subHistory.map(h => ({
              date: h.date,
              value: parseFloat(h.value)
            }));
          })
        );

        // Aggregate by date
        const dateMap = new Map();
        subHistories.forEach(subHist => {
          subHist.forEach(({ date, value }) => {
            const dateKey = new Date(date).toISOString().split('T')[0];
            dateMap.set(dateKey, (dateMap.get(dateKey) || 0) + value);
          });
        });

        // Convert to array and sort
        finalHistory = Array.from(dateMap.entries())
          .map(([date, value]) => ({ date, value }))
          .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());
      }

      // Filter to last 28 days
      finalHistory = finalHistory.slice(-28);

      // Fetch subaccount histories for display
      const subaccountsWithHistory = await Promise.all(
        subaccounts.map(async (sub) => {
          const subHistory = await sql`
            SELECT date, value
            FROM account_value_history
            WHERE account_id = ${sub.id}
            ORDER BY date ASC;
          `;
          const fullHistory = subHistory.map(h => ({
            date: h.date,
            value: parseFloat(h.value)
          }));
          
          // Filter to last 28 days
          return {
            ...sub,
            history: fullHistory.slice(-28)
          };
        })
      );

      return {
        ...account,
        history: finalHistory,
        subaccounts: subaccountsWithHistory,
        isAggregated: !hasMainValue && subaccounts.length > 0
      };
    })
);
---

<Layout title="Gráficos de Portafolio">
  <div class="flex min-h-screen bg-gray-50 w-full">
    <Sidebar activePage="portfolio-history" />
    
    <main class="flex-1 w-full md:ml-64 p-4 sm:p-6 lg:p-8 pt-16 md:pt-8 overflow-y-auto">
      <div class="max-w-7xl mx-auto space-y-4 sm:space-y-6">
        
        <!-- Header responsive -->
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
          <div>
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Histórico de Portafolios</h1>
            <p class="text-sm sm:text-base text-gray-600 mt-1">Visualización del rendimiento histórico de cada cuenta</p>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
          {accountsWithHistory.map((account) => (
            <div class="bg-white rounded-lg sm:rounded-xl shadow-sm border border-gray-200 overflow-hidden">
              <!-- Parent Account Header -->
              <div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-4 sm:px-6 py-3 sm:py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="p-2 bg-blue-100 rounded-lg">
                      <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                      </svg>
                    </div>
                    <div>
                      <h2 class="text-lg sm:text-xl font-bold text-gray-900">{account.name}</h2>
                      <p class="text-xs sm:text-sm text-gray-600">
                        {account.currency}
                        {account.subaccounts.length > 0 && (
                          <span class="ml-2">• {account.subaccounts.length} subcuenta{account.subaccounts.length !== 1 ? 's' : ''}</span>
                        )}
                      </p>
                    </div>
                  </div>
                  {account.isAggregated && (
                    <span class="px-2.5 py-1 bg-amber-100 text-amber-700 rounded-full text-xs font-medium border border-amber-200">
                      Agregado
                    </span>
                  )}
                </div>
              </div>

              <!-- Parent Account Chart -->
              <div class="p-4 sm:p-6">
                <AccountChart
                  accountId={account.id}
                  name={account.isAggregated ? `${account.name} (Total)` : account.name}
                  currency={account.currency}
                  history={account.history}
                />
              </div>

              <!-- Subaccounts Section -->
              {account.subaccounts.length > 0 && (
                <div class="border-t border-gray-200 bg-gray-50 p-4 sm:p-6">
                  <h3 class="text-sm font-semibold text-gray-700 mb-4 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    Subcuentas
                  </h3>
                  <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    {account.subaccounts.map((sub) => (
                      <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <AccountChart
                          accountId={sub.id}
                          name={sub.name}
                          currency={sub.currency}
                          history={sub.history}
                        />
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          ))}
        </div>
      </div>
    </main>
  </div>
</Layout>
