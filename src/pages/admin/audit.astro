---
// src/pages/audit.astro
import Layout from "@layouts/default.astro";
import { sql } from "@lib/db";

// Leer query params
const url = new URL(Astro.request.url);
const page = Math.max(1, Number(url.searchParams.get("page") || 1));
const perPage = Math.max(
  10,
  Math.min(200, Number(url.searchParams.get("perPage") || 50)),
);
const accountFilter = url.searchParams.get("account") || null;
const typeFilter = url.searchParams.get("type") || null;
const dateFrom = url.searchParams.get("from") || null;
const dateTo = url.searchParams.get("to") || null;
const exportCsv = url.searchParams.get("export") === "1";

// Construir condiciones dinámicas (seguras con sql template)
const whereClauses = [];
if (accountFilter)
  whereClauses.push(sql`t.account_id = ${Number(accountFilter)}`);
if (typeFilter) whereClauses.push(sql`t.type = ${typeFilter}`);
if (dateFrom) whereClauses.push(sql`t.date >= ${dateFrom}`);
if (dateTo) whereClauses.push(sql`t.date <= ${dateTo}`);

// Generar WHERE combinado
let whereSql = sql``;
if (whereClauses.length > 0) {
  whereSql = sql`WHERE ${sql.join(whereClauses, sql` AND `)}`;
}

// Si piden export, devolver CSV directamente
if (exportCsv) {
  const rows = await sql`
    SELECT t.id, t.date, t.created_at, t.account_id, a.name as account_name, 
           t.type, t.amount, t.currency, t.previous_value, t.new_value,
           t.related_account_id, ra.name as related_account_name,
           t.related_transaction_id, t.notes, t.user_id, t.usd_to_cop_rate,
           c.name as category_name
    FROM transactions t
    LEFT JOIN accounts a ON a.id = t.account_id
    LEFT JOIN accounts ra ON ra.id = t.related_account_id
    LEFT JOIN categories c ON c.id = t.category_id
    ${whereSql}
    ORDER BY t.date DESC, t.created_at DESC
  `;

  // Construir CSV
  const headers = [
    "id",
    "date",
    "created_at",
    "account_id",
    "account_name",
    "type",
    "amount",
    "currency",
    "previous_value",
    "new_value",
    "related_account_id",
    "related_account_name",
    "related_transaction_id",
    "usd_to_cop_rate",
    "category_name",
    "notes",
    "user_id",
  ];

  const escapeCsv = (v: any) => {
    if (v === null || v === undefined) return "";
    const s = String(v);
    if (s.includes('"') || s.includes(",") || s.includes("\n")) {
      return `"${s.replace(/"/g, '""')}"`;
    }
    return s;
  };

  const lines = [headers.join(",")];
  for (const r of rows) {
    const line = headers.map((h) => escapeCsv(r[h])).join(",");
    lines.push(line);
  }

  const csv = lines.join("\n");
  return new Response(csv, {
    status: 200,
    headers: {
      "Content-Type": "text/csv; charset=utf-8",
      "Content-Disposition": `attachment; filename="transactions_export_${new Date().toISOString().slice(0, 10)}.csv"`,
    },
  });
}

// Consultas para página (paginada)
const offset = (page - 1) * perPage;

const transactions = await sql`
  SELECT t.id, t.date, t.created_at, t.account_id, a.name as account_name, 
         t.type, t.amount, t.currency, t.previous_value, t.new_value,
         t.related_account_id, ra.name as related_account_name,
         t.related_transaction_id, t.notes, t.user_id, t.usd_to_cop_rate,
         c.name as category_name
  FROM transactions t
  LEFT JOIN accounts a ON a.id = t.account_id
  LEFT JOIN accounts ra ON ra.id = t.related_account_id
  LEFT JOIN categories c ON c.id = t.category_id
  ${whereSql}
  ORDER BY t.date DESC, t.created_at DESC
  LIMIT ${perPage} OFFSET ${offset}
`;

// total count
const countRes = await sql`
  SELECT COUNT(*)::int as cnt
  FROM transactions t
  ${whereSql}
`;
const total = countRes[0]?.cnt ?? 0;
const totalPages = Math.max(1, Math.ceil(total / perPage));

// Lista de cuentas para filtro dropdown
const accounts = await sql`SELECT id, name FROM accounts ORDER BY name`;

const transactionTypes = [
  "contribution",
  "withdrawal",
  "transfer_out",
  "transfer_in",
  "adjustment",
  "gain",
  "loss",
  "dividend",
  "interest",
  "fee",
  "initial_balance",
];
---

<Layout title="Auditoría de Transacciones" activePage="audit">
  <section class="p-6 w-full">
    <div class="max-w-7xl mx-auto space-y-6">
      <div class="flex items-center justify-between gap-4">
        <div>
          <h1 class="text-2xl font-bold text-slate-900">
            Auditoría de Transacciones
          </h1>
          <p class="text-sm text-slate-500">
            Registro completo de todas las transacciones financieras
          </p>
        </div>

        <div class="flex items-center gap-2">
          <a
            href={`?${new URLSearchParams(Object.fromEntries([...url.searchParams.entries(), ["export", "1"]]))}`}
            class="inline-flex items-center gap-2 px-4 py-2 bg-slate-800 text-white rounded hover:opacity-95"
          >
            Exportar CSV
          </a>
        </div>
      </div>

      <!-- Filters -->
      <form
        method="get"
        class="bg-white p-4 rounded-lg shadow flex flex-col md:flex-row items-start md:items-center gap-3"
      >
        <div class="flex items-center gap-2">
          <label class="text-sm text-slate-600 mr-2">Cuenta</label>
          <select name="account" class="border rounded px-2 py-1">
            <option value="">Todas</option>
            {
              accounts.map((a) => (
                <option value={a.id} selected={String(a.id) === accountFilter}>
                  {a.name}
                </option>
              ))
            }
          </select>
        </div>

        <div class="flex items-center gap-2">
          <label class="text-sm text-slate-600 mr-2">Tipo</label>
          <select name="type" class="border rounded px-2 py-1">
            <option value="">Todos</option>
            {
              transactionTypes.map((t) => (
                <option value={t} selected={t === typeFilter}>
                  {t}
                </option>
              ))
            }
          </select>
        </div>

        <div class="flex items-center gap-2">
          <label class="text-sm text-slate-600 mr-2">Desde</label>
          <input
            type="date"
            name="from"
            value={dateFrom ?? ""}
            class="border rounded px-2 py-1"
          />
        </div>

        <div class="flex items-center gap-2">
          <label class="text-sm text-slate-600 mr-2">Hasta</label>
          <input
            type="date"
            name="to"
            value={dateTo ?? ""}
            class="border rounded px-2 py-1"
          />
        </div>

        <div class="flex items-center gap-2 ml-auto">
          <label class="text-sm text-slate-600 mr-2">Por página</label>
          <select
            name="perPage"
            class="border rounded px-2 py-1"
            value={String(perPage)}
          >
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50" selected>50</option>
            <option value="100">100</option>
          </select>
          <button type="submit" class="px-3 py-1 bg-blue-600 text-white rounded"
            >Filtrar</button
          >
          <a href="/dashboard/audit" class="px-3 py-1 bg-slate-100 rounded"
            >Limpiar</a
          >
        </div>
      </form>

      <!-- Table -->
      <div class="bg-white rounded-lg shadow overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 text-slate-600 text-left">
            <tr>
              <th class="p-3">Fecha</th>
              <th class="p-3">Cuenta</th>
              <th class="p-3">Tipo</th>
              <th class="p-3 text-right">Monto</th>
              <th class="p-3">Moneda</th>
              <th class="p-3 text-right">Valor Anterior</th>
              <th class="p-3 text-right">Valor Nuevo</th>
              <th class="p-3">Cuenta Relacionada</th>
              <th class="p-3">Categoría</th>
              <th class="p-3">Notas</th>
              <th class="p-3">Usuario</th>
            </tr>
          </thead>
          <tbody>
            {
              transactions.length === 0 ? (
                <tr>
                  <td class="p-6 text-center text-slate-400" colspan="11">
                    No hay registros para estos filtros
                  </td>
                </tr>
              ) : (
                transactions.map((t) => (
                  <tr class="border-t hover:bg-slate-50">
                    <td class="p-3 align-top whitespace-nowrap">
                      {new Date(t.date).toLocaleDateString("es-CO")}
                    </td>
                    <td class="p-3 align-top">
                      {t.account_name ?? t.account_id}
                    </td>
                    <td class="p-3 align-top">
                      <span class="inline-block px-2 py-1 rounded text-xs font-medium bg-slate-100">
                        {t.type}
                      </span>
                    </td>
                    <td class="p-3 align-top text-right font-medium">
                      {t.amount?.toLocaleString("es-CO", {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2,
                      })}
                    </td>
                    <td class="p-3 align-top">
                      <span class="text-xs font-mono">{t.currency}</span>
                      {t.currency === "USD" && t.usd_to_cop_rate && (
                        <span class="text-xs text-slate-500 ml-1">
                          @{t.usd_to_cop_rate}
                        </span>
                      )}
                    </td>
                    <td class="p-3 align-top text-right">
                      {t.previous_value?.toLocaleString("es-CO", {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2,
                      }) ?? "-"}
                    </td>
                    <td class="p-3 align-top text-right">
                      {t.new_value?.toLocaleString("es-CO", {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2,
                      }) ?? "-"}
                    </td>
                    <td class="p-3 align-top">
                      {t.related_account_name ?? 
                       (t.related_account_id ? `#${t.related_account_id}` : "-")}
                    </td>
                    <td class="p-3 align-top">{t.category_name ?? "-"}</td>
                    <td class="p-3 align-top max-w-xs truncate" title={t.notes}>
                      {t.notes ?? ""}
                    </td>
                    <td class="p-3 align-top">{t.user_id ?? "-"}</td>
                  </tr>
                ))
              )
            }
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="flex items-center justify-between">
        <div class="text-sm text-slate-600">Total registros: {total}</div>

        <div class="flex items-center gap-2">
          {
            page > 1 && (
              <a
                class="px-3 py-1 bg-slate-100 rounded hover:bg-slate-200"
                href={`?${new URLSearchParams(Object.fromEntries([...url.searchParams.entries(), ["page", String(page - 1)]]))}`}
              >
                Anterior
              </a>
            )
          }
          <div class="px-3 py-1 bg-white border rounded text-sm">
            Página {page} / {totalPages}
          </div>
          {
            page < totalPages && (
              <a
                class="px-3 py-1 bg-slate-100 rounded hover:bg-slate-200"
                href={`?${new URLSearchParams(Object.fromEntries([...url.searchParams.entries(), ["page", String(page + 1)]]))}`}
              >
                Siguiente
              </a>
            )
          }
        </div>
      </div>
    </div>
  </section>
</Layout>